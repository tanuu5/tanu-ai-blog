<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JP MONITOR</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@300;400;500;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #05080f;
  --panel:    #0a0e1a;
  --panel2:   #0e1525;
  --border:   #161f30;
  --accent:   #00c8f0;
  --accent-d: rgba(0,200,240,0.12);
  --pos:      #00e67a;
  --neg:      #ff3f5e;
  --warn:     #ffaa00;
  --text:     #d8e0ef;
  --text-m:   #7a8ea8;
  --text-d:   #3d4d64;
  --mono:     'Share Tech Mono', monospace;
  --sans:     'Noto Sans JP', sans-serif;
  --disp:     'Orbitron', monospace;
}

*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}

body{
  background:var(--bg);
  color:var(--text);
  font-family:var(--sans);
  font-size:13px;
  line-height:1.5;
}

/* Scanline effect */
body::after{
  content:'';
  position:fixed;
  inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.06) 3px,rgba(0,0,0,0.06) 4px);
  pointer-events:none;
  z-index:9999;
}

/* â”€â”€ HEADER â”€â”€ */
header{
  height:52px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  flex-shrink:0;
  position:relative;
  z-index:200;
}
header::after{
  content:'';
  position:absolute;
  bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
  opacity:.4;
}

.logo{
  font-family:var(--disp);
  font-size:18px;
  font-weight:900;
  letter-spacing:5px;
  color:var(--accent);
  text-shadow:0 0 24px rgba(0,200,240,.45);
  line-height:1;
  display:flex;
  flex-direction:column;
}
.logo-sub{
  font-size:8px;
  letter-spacing:3px;
  color:var(--text-m);
  font-weight:500;
  margin-top:2px;
}

.header-center{
  position:absolute;left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:24px;
}
.stat-badge{
  font-family:var(--mono);
  font-size:9px;
  letter-spacing:1.5px;
  padding:3px 8px;
  border:1px solid var(--border);
  color:var(--text-m);
}
.live-badge{
  display:flex;align-items:center;gap:6px;
  font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--pos);
}
.live-dot{
  width:6px;height:6px;
  border-radius:50%;background:var(--pos);
  box-shadow:0 0 8px var(--pos);
  animation:blink 2s ease-in-out infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

.header-right{display:flex;align-items:center;gap:16px;}
.clock{
  font-family:var(--mono);
  font-size:20px;
  color:var(--accent);
  text-shadow:0 0 12px rgba(0,200,240,.3);
  letter-spacing:2px;
}
.date{font-family:var(--mono);font-size:9px;color:var(--text-m);text-align:right;line-height:1.6;}

/* â”€â”€ MARKET STRIP â”€â”€ */
.market-strip{
  height:56px;
  display:flex;
  gap:1px;
  background:var(--border);
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.ticker{
  flex:1;
  background:var(--panel2);
  padding:6px 14px;
  display:flex;flex-direction:column;gap:1px;
  cursor:default;
  transition:background .15s;
}
.ticker:hover{background:#111827;}
.t-label{font-family:var(--mono);font-size:9px;letter-spacing:1.5px;color:var(--text-m);}
.t-value{font-family:var(--mono);font-size:16px;font-weight:bold;color:var(--text);line-height:1.1;}
.t-change{font-family:var(--mono);font-size:10px;}
.t-change.up{color:var(--pos);}
.t-change.dn{color:var(--neg);}
.t-change.neu{color:var(--text-m);}

/* â”€â”€ MAIN GRID â”€â”€ */
.main{
  display:grid;
  grid-template-columns:268px 1fr 306px;
  height:calc(100vh - 108px);
  overflow:hidden;
}

/* â”€â”€ PANEL BASE â”€â”€ */
.pane{
  display:flex;flex-direction:column;
  background:var(--panel);
  border-right:1px solid var(--border);
  overflow:hidden;
}
.pane:last-child{border-right:none;}

.pane-hd{
  display:flex;align-items:center;gap:8px;
  padding:8px 13px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
  background:rgba(0,0,0,.2);
}
.pane-title{
  font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;
}
.pane-cnt{margin-left:auto;font-family:var(--mono);font-size:9px;color:var(--text-d);}

.scroll{overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.scroll::-webkit-scrollbar{width:3px;}
.scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* â”€â”€ NEWS ITEMS â”€â”€ */
.news-item{
  padding:9px 13px;
  border-bottom:1px solid rgba(22,31,48,.9);
  cursor:pointer;
  transition:background .12s;
}
.news-item:hover{background:var(--accent-d);}
.news-src{font-family:var(--mono);font-size:8px;letter-spacing:1.5px;color:var(--accent);margin-bottom:3px;}
.news-ttl{font-size:11.5px;color:var(--text);line-height:1.45;margin-bottom:3px;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.news-time{font-family:var(--mono);font-size:9px;color:var(--text-d);}

/* â”€â”€ SECTION DIVIDER â”€â”€ */
.sec-label{
  padding:5px 13px;
  font-family:var(--mono);font-size:8px;letter-spacing:2px;color:var(--text-d);
  background:rgba(0,0,0,.3);border-top:1px solid var(--border);border-bottom:1px solid var(--border);
  flex-shrink:0;text-transform:uppercase;
}

/* â”€â”€ WEATHER â”€â”€ */
.weather-box{
  padding:11px 13px;
  display:flex;align-items:center;gap:10px;
  flex-shrink:0;border-bottom:1px solid var(--border);
}
.w-icon{font-size:26px;line-height:1;}
.w-temp{font-family:var(--mono);font-size:22px;color:var(--text);}
.w-detail{font-size:10.5px;color:var(--text-m);}
.w-sub{font-family:var(--mono);font-size:9px;color:var(--text-d);}

/* â”€â”€ EARTHQUAKE â”€â”€ */
.eq-item{
  padding:7px 13px;
  border-bottom:1px solid rgba(22,31,48,.7);
  display:flex;align-items:center;gap:8px;
}
.eq-int{
  width:26px;height:26px;border-radius:3px;
  display:flex;align-items:center;justify-content:center;
  font-family:var(--mono);font-size:12px;font-weight:bold;flex-shrink:0;
}
.i1,.i2{background:rgba(0,200,240,.1);color:var(--accent);}
.i3{background:rgba(0,200,240,.2);color:var(--accent);}
.i4{background:rgba(255,170,0,.15);color:var(--warn);}
.i5{background:rgba(255,100,0,.2);color:#ff6400;}
.i6,.i7{background:rgba(255,63,94,.2);color:var(--neg);}
.eq-place{font-size:11.5px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.eq-meta{font-family:var(--mono);font-size:9px;color:var(--text-d);}

/* â”€â”€ MAP â”€â”€ */
#map{flex:1;background:#06090f;}
.leaflet-tile{filter:brightness(.65) saturate(.4);}
.leaflet-control-attribution{background:rgba(5,8,15,.85)!important;color:var(--text-d)!important;font-size:8px!important;}
.leaflet-control-attribution a{color:var(--text-d)!important;}
.leaflet-popup-content-wrapper{background:var(--panel2);color:var(--text);border:1px solid var(--border);border-radius:3px;box-shadow:0 4px 20px rgba(0,0,0,.6);}
.leaflet-popup-content{font-family:var(--mono);font-size:11px;line-height:1.5;}
.leaflet-popup-tip{background:var(--panel2);}

/* â”€â”€ MAP OVERLAY â”€â”€ */
.map-status{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  z-index:500;display:flex;gap:8px;align-items:center;
  background:rgba(5,8,15,.8);
  border:1px solid var(--border);
  padding:4px 12px;
  font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--accent);
  backdrop-filter:blur(4px);pointer-events:none;
}

/* â”€â”€ TABS â”€â”€ */
.tabs{
  display:flex;border-bottom:1px solid var(--border);flex-shrink:0;
  background:rgba(0,0,0,.2);
}
.tab{
  flex:1;padding:8px 4px;text-align:center;
  font-family:var(--mono);font-size:8px;letter-spacing:1.5px;
  color:var(--text-d);cursor:pointer;
  border-bottom:2px solid transparent;
  transition:all .15s;user-select:none;
}
.tab:hover{color:var(--text-m);}
.tab.on{color:var(--accent);border-bottom-color:var(--accent);}

.tab-pane{display:none;flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.tab-pane::-webkit-scrollbar{width:3px;}
.tab-pane::-webkit-scrollbar-thumb{background:var(--border);}
.tab-pane.on{display:block;}

/* â”€â”€ RELEASE ITEMS â”€â”€ */
.rel-item{
  padding:9px 13px;border-bottom:1px solid rgba(22,31,48,.9);
  cursor:pointer;transition:background .12s;
}
.rel-item:hover{background:var(--accent-d);}
.rel-badge{
  display:inline-block;font-family:var(--mono);font-size:8px;
  letter-spacing:1px;padding:2px 6px;border-radius:2px;margin-bottom:3px;
}
.b-model{background:rgba(0,200,240,.1);color:var(--accent);border:1px solid rgba(0,200,240,.25);}
.b-paper{background:rgba(255,170,0,.08);color:var(--warn);border:1px solid rgba(255,170,0,.2);}
.b-tool{background:rgba(0,230,122,.08);color:var(--pos);border:1px solid rgba(0,230,122,.2);}
.rel-title{font-size:11.5px;color:var(--text);line-height:1.45;margin-bottom:3px;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.rel-meta{font-family:var(--mono);font-size:9px;color:var(--text-d);}

/* â”€â”€ LOADING â”€â”€ */
.loading{
  display:flex;align-items:center;justify-content:center;
  padding:24px 16px;gap:8px;
  color:var(--text-d);font-family:var(--mono);font-size:10px;letter-spacing:1px;
}
.spin{
  width:12px;height:12px;border:1.5px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ ERROR â”€â”€ */
.err{padding:12px 13px;font-family:var(--mono);font-size:9px;color:var(--text-d);letter-spacing:1px;}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">JP MONITOR <span class="logo-sub">JAPAN INTELLIGENCE DASHBOARD</span></div>
  <div class="header-center">
    <div class="live-badge"><div class="live-dot"></div>LIVE</div>
    <div class="stat-badge" id="loc-badge">ä½ç½®å–å¾—ä¸­...</div>
    <div class="stat-badge">JST UTC+9</div>
  </div>
  <div class="header-right">
    <div class="date" id="dateDisp"></div>
    <div class="clock" id="clockDisp"></div>
  </div>
</header>

<!-- MARKET STRIP -->
<div class="market-strip">
  <div class="ticker">
    <div class="t-label">æ—¥çµŒ 225</div>
    <div class="t-value" id="v-nk225">â€•</div>
    <div class="t-change neu" id="c-nk225">å–å¾—ä¸­</div>
  </div>
  <div class="ticker">
    <div class="t-label">TOPIX</div>
    <div class="t-value" id="v-topix">â€•</div>
    <div class="t-change neu" id="c-topix">å–å¾—ä¸­</div>
  </div>
  <div class="ticker">
    <div class="t-label">USD / JPY</div>
    <div class="t-value" id="v-usdjpy">â€•</div>
    <div class="t-change neu" id="c-usdjpy">å–å¾—ä¸­</div>
  </div>
  <div class="ticker">
    <div class="t-label">BTC / JPY</div>
    <div class="t-value" id="v-btcjpy">â€•</div>
    <div class="t-change neu" id="c-btcjpy">å–å¾—ä¸­</div>
  </div>
  <div class="ticker">
    <div class="t-label">WTI åŸæ²¹ $</div>
    <div class="t-value" id="v-wti">â€•</div>
    <div class="t-change neu" id="c-wti">å–å¾—ä¸­</div>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- LEFT PANE -->
  <div class="pane">
    <div class="pane-hd">
      <div class="pane-title">ğŸ¤– AI NEWS JA</div>
      <div class="pane-cnt" id="news-cnt">â€•</div>
    </div>
    <div class="scroll" id="ai-news" style="flex:1;">
      <div class="loading"><div class="spin"></div>ãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—ä¸­...</div>
    </div>

    <div class="sec-label" id="weather-label">ğŸŒ¤ å¤©æ°— â€” å–å¾—ä¸­...</div>
    <div id="weather-box" class="weather-box">
      <div class="loading"><div class="spin"></div></div>
    </div>

    <div class="sec-label">ğŸŒŠ æœ€è¿‘ã®åœ°éœ‡ (JMA)</div>
    <div class="scroll" style="flex:0 0 180px;" id="eq-list">
      <div class="loading"><div class="spin"></div>JMAå–å¾—ä¸­...</div>
    </div>
  </div>

  <!-- CENTER PANE: MAP -->
  <div class="pane" style="position:relative;">
    <div class="map-status">ğŸ—¾ JAPAN MAP â€” LIVE</div>
    <div id="map"></div>
  </div>

  <!-- RIGHT PANE -->
  <div class="pane">
    <div class="tabs">
      <div class="tab on" data-tab="releases">AI ãƒªãƒªãƒ¼ã‚¹</div>
      <div class="tab" data-tab="global">ã‚°ãƒ­ãƒ¼ãƒãƒ«</div>
      <div class="tab" data-tab="papers">arXiv è«–æ–‡</div>
    </div>

    <div class="tab-pane on" id="tab-releases">
      <div class="loading"><div class="spin"></div>å–å¾—ä¸­...</div>
    </div>
    <div class="tab-pane" id="tab-global">
      <div class="loading"><div class="spin"></div>å–å¾—ä¸­...</div>
    </div>
    <div class="tab-pane" id="tab-papers">
      <div class="loading"><div class="spin"></div>arXivå–å¾—ä¸­...</div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClock() {
  const now = new Date();
  const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
  const h = String(jst.getHours()).padStart(2,'0');
  const m = String(jst.getMinutes()).padStart(2,'0');
  const s = String(jst.getSeconds()).padStart(2,'0');
  document.getElementById('clockDisp').textContent = `${h}:${m}:${s}`;
  const y = jst.getFullYear();
  const mo = String(jst.getMonth()+1).padStart(2,'0');
  const d = String(jst.getDate()).padStart(2,'0');
  document.getElementById('dateDisp').innerHTML = `${y}.${mo}.${d}<br>JST`;
}
setInterval(updateClock, 1000);
updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const t = tab.dataset.tab;
    document.querySelectorAll('.tab').forEach(el => el.classList.toggle('on', el.dataset.tab === t));
    document.querySelectorAll('.tab-pane').forEach(el => el.classList.toggle('on', el.id === 'tab-' + t));
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', {
  center: [36.5, 136.0],
  zoom: 5,
  zoomControl: true,
  attributionControl: true
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: 'Â© OpenStreetMap Â© CARTO',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

// Prefecture centers (approximate) for visual reference
const prefectures = [
  [43.06, 141.35,'åŒ—æµ·é“'],[40.82, 140.74,'é’æ£®'],[39.70, 141.15,'å²©æ‰‹'],
  [38.27, 140.87,'å®®åŸ'],[39.72, 140.10,'ç§‹ç”°'],[38.24, 140.36,'å±±å½¢'],
  [37.75, 140.47,'ç¦å³¶'],[36.34, 140.45,'èŒ¨åŸ'],[36.57, 139.88,'æ ƒæœ¨'],
  [36.39, 139.06,'ç¾¤é¦¬'],[35.86, 139.65,'åŸ¼ç‰'],[35.61, 140.12,'åƒè‘‰'],
  [35.69, 139.69,'æ±äº¬'],[35.44, 139.64,'ç¥å¥ˆå·'],[37.90, 139.02,'æ–°æ½Ÿ'],
  [36.70, 137.21,'å¯Œå±±'],[36.59, 136.63,'çŸ³å·'],[35.85, 136.22,'ç¦äº•'],
  [35.67, 138.57,'å±±æ¢¨'],[36.65, 138.18,'é•·é‡'],[35.44, 136.72,'å²é˜œ'],
  [34.97, 138.38,'é™å²¡'],[35.18, 136.91,'æ„›çŸ¥'],[34.73, 136.51,'ä¸‰é‡'],
  [35.00, 135.87,'æ»‹è³€'],[35.02, 135.76,'äº¬éƒ½'],[34.69, 135.50,'å¤§é˜ª'],
  [34.69, 135.19,'å…µåº«'],[34.69, 135.83,'å¥ˆè‰¯'],[33.94, 135.92,'å’Œæ­Œå±±'],
  [35.47, 133.05,'é³¥å–'],[35.47, 133.06,'å³¶æ ¹'],[34.66, 133.93,'å²¡å±±'],
  [34.40, 132.46,'åºƒå³¶'],[34.19, 131.47,'å±±å£'],[34.07, 134.55,'å¾³å³¶'],
  [34.34, 134.04,'é¦™å·'],[33.84, 132.77,'æ„›åª›'],[33.56, 133.53,'é«˜çŸ¥'],
  [33.61, 130.42,'ç¦å²¡'],[33.25, 129.87,'ä½è³€'],[32.74, 129.87,'é•·å´'],
  [32.79, 130.74,'ç†Šæœ¬'],[33.24, 131.61,'å¤§åˆ†'],[31.91, 131.42,'å®®å´'],
  [31.56, 130.56,'é¹¿å…å³¶'],[26.21, 127.68,'æ²–ç¸„']
];

prefectures.forEach(([lat, lon, name]) => {
  L.circleMarker([lat, lon], {
    radius: 3, fillColor: '#00c8f0', color: '#00c8f0',
    weight: 0, opacity: .6, fillOpacity: .3
  }).bindTooltip(name, {
    permanent: false, direction: 'top',
    className: 'custom-tooltip', offset: [0, -4]
  }).addTo(map);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROXIES = [
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
  url => `https://thingproxy.freeboard.io/fetch/${url}`,
];

async function proxyFetch(url, timeout = 10000) {
  for (const makeURL of PROXIES) {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeout);
    try {
      const r = await fetch(makeURL(url), { signal: ctrl.signal });
      if (!r.ok) { clearTimeout(timer); continue; }
      // corsproxy.io returns raw text; codetabs returns raw text too
      const text = await r.text();
      clearTimeout(timer);
      // allorigins wraps in JSON; others return raw
      try { const j = JSON.parse(text); return j.contents ?? text; } catch { return text; }
    } catch { clearTimeout(timer); }
  }
  throw new Error('All proxies failed for: ' + url);
}

function fmtNum(n, dec = 0) {
  if (n == null || isNaN(n)) return 'â€•';
  return n.toLocaleString('ja-JP', { minimumFractionDigits: dec, maximumFractionDigits: dec });
}

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return '';
  const s = (Date.now() - d) / 1000;
  if (s < 60) return 'ãŸã£ãŸä»Š';
  if (s < 3600) return `${Math.floor(s/60)}åˆ†å‰`;
  if (s < 86400) return `${Math.floor(s/3600)}æ™‚é–“å‰`;
  return `${Math.floor(s/86400)}æ—¥å‰`;
}

async function parseRSS(url) {
  try {
    let xml;
    try {
      // ã¾ãšç›´æ¥fetchï¼ˆCORSãŒé€šã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ã‚‚ã‚ã‚‹ï¼‰
      const r = await fetch(url, { signal: AbortSignal.timeout(6000) });
      if (r.ok) xml = await r.text();
    } catch { /* fall through to proxy */ }
    if (!xml) xml = await proxyFetch(url);
    const doc = new DOMParser().parseFromString(xml, 'text/xml');
    const items = doc.querySelectorAll('item, entry');
    return Array.from(items).slice(0, 30).map(el => {
      const t = sel => el.querySelector(sel)?.textContent?.trim() || '';
      // RDF 1.0: linkã¯rdf:aboutå±æ€§ or <link>ãƒ†ã‚­ã‚¹ãƒˆ or <link href>
      const linkEl = el.querySelector('link');
      const link = el.getAttribute('rdf:about')
        || (linkEl ? (linkEl.textContent?.trim() || linkEl.getAttribute('href') || '') : '');
      return {
        title: t('title'),
        link,
        pubDate: t('pubDate') || t('dc\\:date') || t('published') || t('updated'),
        desc: t('description') || t('summary') || ''
      };
    }).filter(i => i.title);
  } catch { return []; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKET DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchTicker(symbol) {
  try {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
    const raw = await proxyFetch(url);
    const data = JSON.parse(raw);
    const meta = data?.chart?.result?.[0]?.meta;
    if (!meta) return null;
    const price = meta.regularMarketPrice;
    const prev  = meta.chartPreviousClose || meta.previousClose;
    if (!price || !prev) return null;
    const chg = price - prev;
    const pct = (chg / prev) * 100;
    return { price, chg, pct };
  } catch { return null; }
}

function renderTicker(id, data, dec = 0) {
  const vEl = document.getElementById('v-' + id);
  const cEl = document.getElementById('c-' + id);
  if (!data) { vEl.textContent = 'N/A'; cEl.textContent = 'å–å¾—å¤±æ•—'; cEl.className = 't-change neu'; return; }
  vEl.textContent = fmtNum(data.price, dec);
  const sign = data.chg >= 0 ? '+' : '';
  cEl.textContent = `${sign}${fmtNum(data.chg, dec)} (${sign}${data.pct.toFixed(2)}%)`;
  cEl.className = 't-change ' + (data.chg >= 0 ? 'up' : 'dn');
}

async function loadMarkets() {
  const pairs = [
    { sym: '^N225',    id: 'nk225', dec: 0 },
    { sym: '^TPX',     id: 'topix', dec: 2 },
    { sym: 'USDJPY=X', id: 'usdjpy', dec: 2 },
    { sym: 'BTC-JPY',  id: 'btcjpy', dec: 0 },
    { sym: 'CL=F',     id: 'wti',   dec: 2 },
  ];
  await Promise.all(pairs.map(async p => renderTicker(p.id, await fetchTicker(p.sym), p.dec)));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEATHER (Open-Meteo, no API key)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WX = {
  0:['â˜€ï¸','å¿«æ™´'],1:['ğŸŒ¤','ã»ã¼å¿«æ™´'],2:['â›…','éƒ¨åˆ†æ›‡'],3:['â˜ï¸','æ›‡ã‚Š'],
  45:['ğŸŒ«','éœ§'],48:['ğŸŒ«','ç€æ°·éœ§'],
  51:['ğŸŒ¦','éœ§é›¨ï¼ˆå¼±ï¼‰'],53:['ğŸŒ¦','éœ§é›¨'],55:['ğŸŒ§','éœ§é›¨ï¼ˆå¼·ï¼‰'],
  61:['ğŸŒ§','å°é›¨'],63:['ğŸŒ§','é›¨'],65:['ğŸŒ§','å¤§é›¨'],
  71:['ğŸŒ¨','å°é›ª'],73:['â„ï¸','é›ª'],75:['â„ï¸','å¤§é›ª'],
  80:['ğŸŒ¦','ã«ã‚ã‹é›¨'],81:['ğŸŒ§','å¼·ã„ã«ã‚ã‹é›¨'],82:['â›ˆ','æ¿€ã—ã„ã«ã‚ã‹é›¨'],
  95:['â›ˆ','é›·é›¨'],96:['â›ˆ','é›·é›¨ï¼ˆé›¹ï¼‰'],99:['â›ˆ','æ¿€ã—ã„é›·é›¨']
};

async function loadWeather() {
  try {
    const { lat, lon } = window._loc;
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,precipitation,weathercode,windspeed_10m,relative_humidity_2m&timezone=Asia%2FTokyo`;
    const r = await fetch(url, { signal: AbortSignal.timeout(8000) });
    const d = await r.json();
    const c = d.current;
    const [icon, desc] = WX[c.weathercode] || ['ğŸŒ¡','â€•'];
    document.getElementById('weather-box').innerHTML = `
      <div class="w-icon">${icon}</div>
      <div>
        <div class="w-temp">${c.temperature_2m}Â°C</div>
        <div class="w-detail">${desc}ã€€ä½“æ„Ÿ ${c.apparent_temperature}Â°Cã€€æ¹¿åº¦ ${c.relative_humidity_2m}%</div>
        <div class="w-sub">é¢¨é€Ÿ ${c.windspeed_10m} m/sã€€é™æ°´ ${c.precipitation} mm</div>
      </div>
    `;
  } catch {
    document.getElementById('weather-box').innerHTML = '<div class="err">å¤©æ°—å–å¾—å¤±æ•—</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EARTHQUAKES (JMA) + MAP MARKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INT_NUM = { '1':1,'2':2,'3':3,'4':4,'5-':5,'5+':5,'6-':6,'6+':6,'7':7 };
const eqLayerGroup = L.layerGroup().addTo(map);

function eqColor(int) {
  const n = INT_NUM[int] || 1;
  if (n <= 2) return '#00c8f0';
  if (n === 3) return '#00e67a';
  if (n === 4) return '#ffaa00';
  if (n === 5) return '#ff6400';
  return '#ff3f5e';
}

async function loadEarthquakes() {
  try {
    let raw;
    // JMAã¯CORSãƒ˜ãƒƒãƒ€ãƒ¼ã‚ã‚Šã€ç›´æ¥fetchã‚’å…ˆã«è©¦ã¿ã‚‹
    try {
      const r = await fetch('https://www.jma.go.jp/bosai/quake/data/list.json', { signal: AbortSignal.timeout(6000) });
      raw = await r.text();
    } catch {
      raw = await proxyFetch('https://www.jma.go.jp/bosai/quake/data/list.json');
    }
    const data = JSON.parse(raw).slice(0, 10);

    // JMA list.json: maxi = æœ€å¤§éœ‡åº¦æ–‡å­—åˆ—, int = ã‚¨ãƒªã‚¢åˆ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—
    const getInt = eq => eq.maxi || (typeof eq.int === 'string' ? eq.int : 'â€•');
    const getAnm = eq => {
      if (!eq.anm) return '';
      if (Array.isArray(eq.anm)) return eq.anm.join(' / ');
      return String(eq.anm);
    };
    // JMA cod: "+ç·¯åº¦6æ¡+çµŒåº¦7æ¡" ä¾‹ "+351234+1392345"
    const parseCod = cod => {
      if (!cod) return null;
      const m = String(cod).match(/([+-]\d+)([+-]\d+)/);
      if (!m) return null;
      const parseDMS = s => {
        const sign = s[0] === '-' ? -1 : 1;
        const n = s.slice(1);
        // ç·¯åº¦6æ¡DDMMSS or çµŒåº¦7æ¡DDDMMSS
        const len = n.length;
        if (len === 6) return sign * (parseInt(n.slice(0,2)) + parseInt(n.slice(2,4))/60 + parseInt(n.slice(4,6))/3600);
        if (len === 7) return sign * (parseInt(n.slice(0,3)) + parseInt(n.slice(3,5))/60 + parseInt(n.slice(5,7))/3600);
        return null;
      };
      const lat = parseDMS(m[1]);
      const lon = parseDMS(m[2]);
      if (!lat || !lon) return null;
      return { lat, lon };
    };

    // ãƒªã‚¹ãƒˆUI
    document.getElementById('eq-list').innerHTML = data.map(eq => {
      const intStr = getInt(eq);
      const intNum = INT_NUM[intStr] || 1;
      const cls    = `eq-int i${Math.min(intNum, 7)}`;
      return `
        <div class="eq-item">
          <div class="${cls}">${intStr}</div>
          <div style="flex:1;min-width:0;">
            <div class="eq-place">${eq.hyp || 'ä¸æ˜'}</div>
            <div class="eq-meta">M${eq.mag || '?'}ã€€${getAnm(eq).slice(0, 20)}</div>
          </div>
        </div>
      `;
    }).join('');

    // åœ°å›³ãƒãƒ¼ã‚«ãƒ¼
    eqLayerGroup.clearLayers();
    data.forEach(eq => {
      const pos = parseCod(eq.cod);
      if (!pos) return;
      const intStr = getInt(eq);
      const color  = eqColor(intStr);
      const radius = Math.max(6, (INT_NUM[intStr] || 1) * 4);
      L.circleMarker([pos.lat, pos.lon], {
        radius, fillColor: color, color,
        weight: 1, fillOpacity: 0.5, opacity: 0.8
      }).bindPopup(`
        <b>${eq.hyp || 'ä¸æ˜'}</b><br>
        éœ‡åº¦ ${intStr}ã€€M${eq.mag || '?'}<br>
        <span style="color:#7a8ea8;font-size:10px">${getAnm(eq).slice(0,40)}</span>
      `).addTo(eqLayerGroup);
    });

  } catch {
    document.getElementById('eq-list').innerHTML = '<div class="err">åœ°éœ‡ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI NEWS JA (Left panel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AI_FEEDS_JA = [
  { url: 'https://rss.itmedia.co.jp/rss/2.0/ait.xml',                          src: 'ITmedia AI+' },
  { url: 'https://forest.watch.impress.co.jp/data/rss/1.0/wf/feed.rdf',        src: 'ã‚„ã˜ã†ã¾Watch' },
  { url: 'https://www.itmedia.co.jp/news/subtop/rss/bursts.rdf',               src: 'ITmedia NEWS' },
  { url: 'https://xtech.nikkei.com/rss/index.rdf',                             src: 'æ—¥çµŒXTECH' },
];

async function loadAINews() {
  let all = [];
  for (const f of AI_FEEDS_JA) {
    const items = await parseRSS(f.url);
    items.forEach(i => { i._src = f.src; });
    all = all.concat(items);
  }
  all.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
  const el = document.getElementById('ai-news');
  if (!all.length) { el.innerHTML = '<div class="err">ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—ï¼ˆRSSãƒ–ãƒ­ãƒƒã‚¯ã®å¯èƒ½æ€§ï¼‰</div>'; return; }
  document.getElementById('news-cnt').textContent = all.length + ' ä»¶';
  el.innerHTML = all.slice(0, 25).map(i => `
    <div class="news-item" onclick="window.open('${i.link}','_blank')">
      <div class="news-src">${i._src}</div>
      <div class="news-ttl">${i.title}</div>
      <div class="news-time">${timeAgo(i.pubDate)}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI RELEASES (tab)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AI_KW = ['model','llm','gpt','claude','gemini','llama','mistral','qwen','release','launch','api','ai','agent','diffusion','multimodal'];

const RELEASE_FEEDS = [
  { url: 'https://huggingface.co/blog/feed.xml',           src: 'HuggingFace', badge: 'b-model' },
  { url: 'https://blog.google/technology/ai/rss/',         src: 'Google AI',   badge: 'b-tool' },
  { url: 'https://openai.com/news/rss.xml',                src: 'OpenAI',      badge: 'b-model' },
  { url: 'https://www.anthropic.com/news.rss',             src: 'Anthropic',   badge: 'b-model' },
];

async function loadReleases() {
  let all = [];
  for (const f of RELEASE_FEEDS) {
    const items = await parseRSS(f.url);
    items.forEach(i => { i._src = f.src; i._badge = f.badge; });
    const filtered = items.filter(i => AI_KW.some(k => (i.title + i.desc).toLowerCase().includes(k)));
    all = all.concat(filtered);
  }
  all.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
  const el = document.getElementById('tab-releases');
  if (!all.length) { el.innerHTML = '<div class="err">ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ã€‚ã—ã°ã‚‰ãå¾Œã«å†è©¦è¡Œã—ã¾ã™ã€‚</div>'; return; }
  el.innerHTML = all.slice(0, 20).map(i => `
    <div class="rel-item" onclick="window.open('${i.link}','_blank')">
      <div class="rel-badge ${i._badge}">${i._src}</div>
      <div class="rel-title">${i.title}</div>
      <div class="rel-meta">${timeAgo(i.pubDate)}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL AI NEWS (tab)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GLOBAL_FEEDS = [
  { url: 'https://techcrunch.com/feed/', src: 'TechCrunch' },
  { url: 'https://venturebeat.com/feed/', src: 'VentureBeat' },
  { url: 'https://feeds.arstechnica.com/arstechnica/technology-lab', src: 'Ars Technica' },
];

async function loadGlobal() {
  let all = [];
  for (const f of GLOBAL_FEEDS) {
    const items = await parseRSS(f.url);
    items.forEach(i => { i._src = f.src; });
    const filtered = items.filter(i => AI_KW.some(k => (i.title + i.desc).toLowerCase().includes(k)));
    all = all.concat(filtered);
  }
  all.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
  const el = document.getElementById('tab-global');
  if (!all.length) { el.innerHTML = '<div class="err">ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—å¤±æ•—</div>'; return; }
  el.innerHTML = all.slice(0, 20).map(i => `
    <div class="news-item" onclick="window.open('${i.link}','_blank')">
      <div class="news-src">${i._src}</div>
      <div class="news-ttl">${i.title}</div>
      <div class="news-time">${timeAgo(i.pubDate)}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  arXiv CS.AI PAPERS (tab)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPapers() {
  const items = await parseRSS('https://rss.arxiv.org/rss/cs.AI');
  const el = document.getElementById('tab-papers');
  if (!items.length) { el.innerHTML = '<div class="err">arXivãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—å¤±æ•—</div>'; return; }
  el.innerHTML = items.slice(0, 20).map(i => `
    <div class="rel-item" onclick="window.open('${i.link}','_blank')">
      <div class="rel-badge b-paper">arXiv Â· CS.AI</div>
      <div class="rel-title">${i.title}</div>
      <div class="rel-meta">${timeAgo(i.pubDate)}</div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEOLOCATION + REVERSE GEOCODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_LOC = { lat: 35.6812, lon: 139.7671, name: 'æ±äº¬' };

async function reverseGeocode(lat, lon) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ja`;
    const r = await fetch(url, { headers: { 'Accept-Language': 'ja' }, signal: AbortSignal.timeout(5000) });
    const d = await r.json();
    const a = d.address || {};
    return a.city || a.town || a.village || a.county || a.state || 'ä¸æ˜';
  } catch { return null; }
}

async function resolveLocation() {
  return new Promise(resolve => {
    if (!navigator.geolocation) { resolve(DEFAULT_LOC); return; }
    navigator.geolocation.getCurrentPosition(
      async pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const name = await reverseGeocode(lat, lon) || DEFAULT_LOC.name;
        resolve({ lat, lon, name });
      },
      () => resolve(DEFAULT_LOC),
      { timeout: 6000, maximumAge: 600_000 }
    );
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  const loc = await resolveLocation();
  window._loc = loc;
  document.getElementById('loc-badge').textContent = loc.name;
  document.getElementById('weather-label').textContent = `ğŸŒ¤ å¤©æ°— â€” ${loc.name}`;

  await Promise.all([
    loadMarkets(),
    loadWeather(),
    loadEarthquakes(),
    loadAINews(),
    loadReleases(),
    loadGlobal(),
    loadPapers()
  ]);
}

init();

// Refresh intervals
setInterval(loadMarkets,     60_000);   // 1 min
setInterval(loadWeather,    600_000);   // 10 min
setInterval(loadEarthquakes, 90_000);   // 90 sec
setInterval(loadAINews,     300_000);   // 5 min
setInterval(loadReleases,   600_000);   // 10 min
setInterval(loadGlobal,     300_000);   // 5 min
</script>
</body>
</html>
