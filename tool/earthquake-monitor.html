<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·Šæ€¥åœ°éœ‡é€Ÿå ±ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <style>
        /* ====== ãƒ†ãƒ¼ãƒå¤‰æ•° ====== */
        :root {
            --bg-primary: #0a0a12;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --card-bg: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            --map-bg-start: #0a1628;
            --map-bg-end: #061018;
            --map-land: #1e3a5f;
            --map-land-hover: #2a4a7f;
            --map-border: #3a5a8f;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --border-color: #2a2a4e;
            --accent-color: #a0a0ff;
            --accent-gradient: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            --success-color: #4ade80;
            --warning-color: #fbbf24;
            --error-color: #ef4444;
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --card-bg: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            --map-bg-start: #e8f4fc;
            --map-bg-end: #d0e8f8;
            --map-land: #a8d5ba;
            --map-land-hover: #8fc9a3;
            --map-border: #6db88a;
            --text-primary: #1a1a2e;
            --text-secondary: #4a4a6a;
            --text-muted: #888888;
            --border-color: #d0d0e0;
            --accent-color: #5050c0;
            --accent-gradient: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo h1 {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--text-primary) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.1);
        }

        .theme-toggle-icon {
            font-size: 1rem;
        }

        .settings-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .settings-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .settings-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .settings-overlay.active .settings-panel {
            transform: translateY(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .settings-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .settings-close:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            gap: 16px;
        }

        .setting-info {
            flex: 1;
        }

        .setting-label {
            display: block;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .setting-desc {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--border-color);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #4ade80;
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ */
        .setting-select {
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 140px;
        }

        .setting-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* é€šçŸ¥è¨±å¯ */
        .notification-permission {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-top: 8px;
        }

        .permission-status {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .permission-status.granted {
            color: var(--success-color);
        }

        .permission-status.denied {
            color: var(--error-color);
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-secondary {
            background: var(--border-color);
        }

        .test-buttons {
            display: flex;
            gap: 8px;
        }

        /* è¨­å®šãƒ•ãƒƒã‚¿ãƒ¼ */
        .settings-footer {
            display: flex;
            justify-content: space-between;
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4ade80;
        }

        .status-dot.disconnected {
            background: #ef4444;
        }

        .status-dot.connecting {
            background: #fbbf24;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .map-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            min-height: 650px;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .map-title {
            font-size: 1.1rem;
            color: var(--accent-color);
        }

        .map-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .map-mode-toggle {
            display: flex;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 3px;
            border: 1px solid var(--border-color);
        }

        .mode-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--accent-color);
            color: #fff;
        }

        .current-time {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-family: 'Courier New', monospace;
        }

        /* ä¸€è¦§ãƒ¢ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .history-filter {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .filter-group select {
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .history-count {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* åœ°å›³ä¸Šã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .map-popup {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 100;
            pointer-events: auto;
        }

        .map-popup::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--border-color);
        }

        .map-popup-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-popup-shindo {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #fff;
        }

        .map-popup-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .map-popup-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
        }

        #japan-map {
            width: 100%;
            height: 550px;
            position: relative;
        }

        #japan-map svg {
            width: 100%;
            height: 100%;
        }

        .prefecture-path {
            transition: fill 0.3s ease;
            cursor: pointer;
        }

        /* éœ‡åº¦ã‚«ãƒ©ãƒ¼ */
        .shindo-1 { fill: #5b5bff; }
        .shindo-2 { fill: #7b7bff; }
        .shindo-3 { fill: #00c8ff; }
        .shindo-4 { fill: #00ff7f; }
        .shindo-5l { fill: #ffff00; }
        .shindo-5u { fill: #ffc800; }
        .shindo-6l { fill: #ff8c00; }
        .shindo-6u { fill: #ff4500; }
        .shindo-7 { fill: #ff00ff; }

        .epicenter {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #ff0000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: epicenter-pulse 1s infinite;
        }

        .epicenter::before {
            content: 'Ã—';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0000;
            font-size: 20px;
            font-weight: bold;
        }

        @keyframes epicenter-pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .panel-header {
            padding: 16px 20px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .last-update {
            margin-left: auto;
            font-size: 0.75rem;
            font-weight: normal;
            color: var(--text-muted);
        }

        .panel-content {
            padding: 16px 20px;
        }

        /* EEW Alert Panel */
        .eew-panel {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .eew-panel.active {
            border-color: #ff0000;
            animation: alert-flash 0.5s infinite;
        }

        @keyframes alert-flash {
            0%, 100% { background: var(--card-bg); }
            50% { background: linear-gradient(180deg, #3a1a1a 0%, #2a1616 100%); }
        }

        .eew-info {
            text-align: center;
            padding: 20px;
        }

        .eew-waiting {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .eew-active .eew-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ff4444;
            margin-bottom: 16px;
        }

        .eew-active .eew-shindo {
            font-size: 4rem;
            font-weight: 900;
            margin: 10px 0;
        }

        .eew-active .eew-details {
            color: #ccc;
            margin-top: 16px;
        }

        /* Recent Earthquakes List */
        .quake-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .quake-item {
            display: flex;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .quake-item:hover {
            background: rgba(255,255,255,0.03);
            margin: 0 -20px;
            padding: 14px 20px;
        }

        .quake-item:last-child {
            border-bottom: none;
        }

        .quake-shindo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            flex-shrink: 0;
            color: #fff;
        }

        .quake-info {
            flex: 1;
            min-width: 0;
        }

        .quake-location {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .quake-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .quake-item.favorite-affected {
            background: rgba(74, 222, 128, 0.1);
            margin: 0 -20px;
            padding: 14px 20px;
            border-left: 3px solid var(--success-color);
        }

        .quake-item.favorite-affected:hover {
            background: rgba(74, 222, 128, 0.15);
        }

        /* Shindo Legend */
        .legend {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .legend-circle {
            border-radius: 50%;
            background: var(--accent-color);
            margin-bottom: 4px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .legend-magnitude {
            align-items: flex-end;
        }

        .legend-magnitude .legend-item {
            justify-content: flex-end;
        }

        .legend-note {
            flex-direction: row;
            font-size: 0.7rem;
            color: var(--text-muted);
            grid-column: span 2;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border-left: 4px solid var(--success-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            color: var(--text-primary);
        }

        .toast.error {
            border-left-color: var(--error-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 18, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 10;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        /* Connection Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .modal h3 {
            margin-bottom: 16px;
            color: var(--error-color);
        }

        .modal p {
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        footer {
            margin-top: 30px;
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .footer-main {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .footer-credits {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
        }

        .credit-section {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .credit-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .credit-separator {
            color: var(--border-color);
            margin: 0 4px;
        }

        footer a {
            color: var(--accent-color);
            text-decoration: none;
            transition: opacity 0.2s;
        }

        footer a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .footer-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .footer-disclaimer {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        @media (max-width: 600px) {
            .footer-credits {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">âš¡</div>
                <h1>ç·Šæ€¥åœ°éœ‡é€Ÿå ±ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" id="theme-toggle" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
                    <span class="theme-toggle-icon" id="theme-icon">ğŸŒ™</span>
                    <span id="theme-label">ãƒ€ãƒ¼ã‚¯</span>
                </button>
                <button class="settings-btn" id="settings-btn" title="è¨­å®š">
                    <span>âš™ï¸</span>
                    <span>è¨­å®š</span>
                </button>
                <div class="status">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">æ¥ç¶šä¸­...</span>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <div class="map-container">
                <div class="map-header">
                    <span class="map-title">ğŸ“ æ—¥æœ¬å…¨å›½ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ°éœ‡æƒ…å ±</span>
                    <div class="map-controls">
                        <div class="map-mode-toggle">
                            <button class="mode-btn active" id="mode-realtime" title="ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ¼ãƒ‰">
                                <span>âš¡</span> ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ 
                            </button>
                            <button class="mode-btn" id="mode-history" title="éå»ã®åœ°éœ‡ä¸€è¦§">
                                <span>ğŸ“Š</span> ä¸€è¦§è¡¨ç¤º
                            </button>
                        </div>
                        <span class="current-time" id="current-time"></span>
                    </div>
                </div>
                <!-- ä¸€è¦§ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="history-filter" id="history-filter" style="display: none;">
                    <div class="filter-group">
                        <label>æœŸé–“:</label>
                        <select id="filter-period">
                            <option value="24">éå»24æ™‚é–“</option>
                            <option value="72">éå»3æ—¥é–“</option>
                            <option value="168" selected>éå»1é€±é–“</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>éœ‡åº¦:</label>
                        <select id="filter-scale">
                            <option value="0">ã™ã¹ã¦</option>
                            <option value="10">éœ‡åº¦1ä»¥ä¸Š</option>
                            <option value="20">éœ‡åº¦2ä»¥ä¸Š</option>
                            <option value="30" selected>éœ‡åº¦3ä»¥ä¸Š</option>
                            <option value="40">éœ‡åº¦4ä»¥ä¸Š</option>
                            <option value="45">éœ‡åº¦5å¼±ä»¥ä¸Š</option>
                        </select>
                    </div>
                    <button class="btn btn-small" id="load-history">èª­ã¿è¾¼ã¿</button>
                    <span class="history-count" id="history-count"></span>
                </div>
                <div id="japan-map">
                    <div class="loading-overlay" id="map-loading">
                        <div class="spinner"></div>
                        <span>åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                </div>
                <div class="legend" id="legend-shindo">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #5b5bff;"></div>
                        <span>éœ‡åº¦1</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00c8ff;"></div>
                        <span>éœ‡åº¦3</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffff00;"></div>
                        <span>éœ‡åº¦5å¼±</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4500;"></div>
                        <span>éœ‡åº¦6å¼·</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff00ff;"></div>
                        <span>éœ‡åº¦7</span>
                    </div>
                </div>
                <!-- ä¸€è¦§ãƒ¢ãƒ¼ãƒ‰ç”¨ã®å‡¡ä¾‹ -->
                <div class="legend legend-magnitude" id="legend-magnitude" style="display: none;">
                    <div class="legend-item">
                        <div class="legend-circle" style="width:10px; height:10px;"></div>
                        <span>M2</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="width:16px; height:16px;"></div>
                        <span>M4</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="width:24px; height:24px;"></div>
                        <span>M6+</span>
                    </div>
                    <div class="legend-item legend-note">
                        å††ã®å¤§ãã• = ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ / è‰² = æœ€å¤§éœ‡åº¦
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel eew-panel" id="eew-panel">
                    <div class="panel-header">
                        <span>ğŸš¨</span>
                        ç·Šæ€¥åœ°éœ‡é€Ÿå ±
                    </div>
                    <div class="panel-content">
                        <div class="eew-info" id="eew-info">
                            <div class="eew-waiting">
                                ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã‚’ç›£è¦–ä¸­...<br>
                                <small style="color:#666;">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å—ä¿¡ã—ã¾ã™</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span>ğŸ“‹</span>
                        æœ€è¿‘ã®åœ°éœ‡æƒ…å ±
                        <span class="last-update" id="last-update"></span>
                    </div>
                    <div class="panel-content">
                        <div class="quake-list" id="quake-list">
                            <div style="text-align: center; color: #666; padding: 20px;">
                                ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-main">
                <div class="footer-credits">
                    <div class="credit-section">
                        <span class="credit-label">ãƒ‡ãƒ¼ã‚¿æä¾›</span>
                        <a href="https://www.p2pquake.net/" target="_blank" rel="noopener">P2Påœ°éœ‡æƒ…å ±</a>
                        <span class="credit-separator">|</span>
                        <a href="https://www.jma.go.jp/" target="_blank" rel="noopener">æ°—è±¡åº</a>
                    </div>
                    <div class="credit-section">
                        <span class="credit-label">åœ°å›³ãƒ‡ãƒ¼ã‚¿</span>
                        <a href="https://github.com/dataofjapan/land" target="_blank" rel="noopener">dataofjapan/land</a>
                        <span class="credit-separator">|</span>
                        <span>å‡ºå…¸: åœ°çƒåœ°å›³æ—¥æœ¬</span>
                    </div>
                    <div class="credit-section">
                        <span class="credit-label">ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</span>
                        <a href="https://d3js.org/" target="_blank" rel="noopener">D3.js v7</a>
                    </div>
                </div>
                <div class="footer-meta">
                    <span>Built with Claude (Opus 4.5) by Anthropic</span>
                    <span class="credit-separator">|</span>
                    <span>Created: 2025å¹´12æœˆ30æ—¥</span>
                </div>
            </div>
            <div class="footer-disclaimer">
                â€»ã“ã®ã‚¢ãƒ—ãƒªã¯é˜²ç½ç›®çš„ã®å‚è€ƒæƒ…å ±ã§ã™ã€‚æ­£ç¢ºãªæƒ…å ±ã¯æ°—è±¡åºã®å…¬å¼ç™ºè¡¨ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
            </div>
        </footer>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <div class="modal-overlay" id="reconnect-modal">
        <div class="modal">
            <h3>æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ</h3>
            <p>ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã—ã¾ã™ã‹ï¼Ÿ</p>
            <button class="btn" onclick="reconnect()">å†æ¥ç¶š</button>
        </div>
    </div>

    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <div class="settings-overlay" id="settings-overlay">
        <div class="settings-panel">
            <div class="settings-header">
                <h2>âš™ï¸ è¨­å®š</h2>
                <button class="settings-close" id="settings-close">âœ•</button>
            </div>
            <div class="settings-content">
                <!-- é€šçŸ¥è¨­å®š -->
                <div class="settings-section">
                    <h3>ğŸ”” é€šçŸ¥è¨­å®š</h3>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥</span>
                            <span class="setting-desc">åœ°éœ‡ç™ºç”Ÿæ™‚ã«ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤º</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-notification">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" id="notification-threshold-container">
                        <div class="setting-info">
                            <span class="setting-label">é€šçŸ¥ã™ã‚‹éœ‡åº¦</span>
                            <span class="setting-desc">ã“ã®éœ‡åº¦ä»¥ä¸Šã§é€šçŸ¥</span>
                        </div>
                        <select id="setting-notification-threshold" class="setting-select">
                            <option value="10">éœ‡åº¦1ä»¥ä¸Š</option>
                            <option value="20">éœ‡åº¦2ä»¥ä¸Š</option>
                            <option value="30" selected>éœ‡åº¦3ä»¥ä¸Š</option>
                            <option value="40">éœ‡åº¦4ä»¥ä¸Š</option>
                            <option value="45">éœ‡åº¦5å¼±ä»¥ä¸Š</option>
                            <option value="50">éœ‡åº¦5å¼·ä»¥ä¸Š</option>
                            <option value="55">éœ‡åº¦6å¼±ä»¥ä¸Š</option>
                            <option value="60">éœ‡åº¦6å¼·ä»¥ä¸Š</option>
                            <option value="70">éœ‡åº¦7ã®ã¿</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã‚’å¸¸ã«é€šçŸ¥</span>
                            <span class="setting-desc">EEWå—ä¿¡æ™‚ã¯éœ‡åº¦ã«é–¢ã‚ã‚‰ãšé€šçŸ¥</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-eew-notification" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="notification-permission" id="notification-permission">
                        <span class="permission-status" id="permission-status">é€šçŸ¥ã®è¨±å¯ãŒå¿…è¦ã§ã™</span>
                        <button class="btn btn-small" id="request-permission-btn">è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
                    </div>
                </div>

                <!-- ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š -->
                <div class="settings-section">
                    <h3>ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</h3>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">åœ°éœ‡æƒ…å ±ã®è­¦å‘ŠéŸ³</span>
                            <span class="setting-desc">éœ‡åº¦4ä»¥ä¸Šã§ãƒ“ãƒ¼ãƒ—éŸ³ã‚’å†ç”Ÿ</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-sound" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã®è­¦å‘ŠéŸ³</span>
                            <span class="setting-desc">EEWå—ä¿¡æ™‚ã«è­¦å‘ŠéŸ³ã‚’å†ç”Ÿ</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-eew-sound" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">ã‚µã‚¦ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ</span>
                            <span class="setting-desc">è­¦å‘ŠéŸ³ã‚’ç¢ºèªã§ãã¾ã™</span>
                        </div>
                        <div class="test-buttons">
                            <button class="btn btn-small btn-secondary" onclick="playAlert()">é€šå¸¸</button>
                            <button class="btn btn-small btn-secondary" onclick="playEEWAlert()">EEW</button>
                        </div>
                    </div>
                </div>

                <!-- è¡¨ç¤ºè¨­å®š -->
                <div class="settings-section">
                    <h3>ğŸ“‹ è¡¨ç¤ºè¨­å®š</h3>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">åœ°éœ‡æƒ…å ±ã®è¡¨ç¤ºä»¶æ•°</span>
                            <span class="setting-desc">ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¡¨ç¤ºã™ã‚‹ä»¶æ•°</span>
                        </div>
                        <select id="setting-display-count" class="setting-select">
                            <option value="5">5ä»¶</option>
                            <option value="10" selected>10ä»¶</option>
                            <option value="15">15ä»¶</option>
                            <option value="20">20ä»¶</option>
                        </select>
                    </div>
                </div>

                <!-- ãŠæ°—ã«å…¥ã‚Šåœ°åŸŸ -->
                <div class="settings-section">
                    <h3>ğŸ“ ãŠæ°—ã«å…¥ã‚Šåœ°åŸŸ</h3>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">å„ªå…ˆè¡¨ç¤ºã™ã‚‹åœ°åŸŸ</span>
                            <span class="setting-desc">ã“ã®åœ°åŸŸã®åœ°éœ‡ã‚’å„ªå…ˆçš„ã«é€šçŸ¥</span>
                        </div>
                        <select id="setting-favorite-region" class="setting-select">
                            <option value="">è¨­å®šãªã—</option>
                            <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
                            <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
                            <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
                            <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
                            <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
                            <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
                            <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
                            <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
                            <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
                            <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
                            <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
                            <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
                            <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                            <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
                            <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
                            <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
                            <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
                            <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
                            <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
                            <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
                            <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
                            <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
                            <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
                            <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
                            <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
                            <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
                            <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
                            <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
                            <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
                            <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
                            <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
                            <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
                            <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
                            <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
                            <option value="å±±å£çœŒ">å±±å£çœŒ</option>
                            <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
                            <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
                            <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
                            <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
                            <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
                            <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
                            <option value="é•·å´çœŒ">é•·å´çœŒ</option>
                            <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
                            <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
                            <option value="å®®å´çœŒ">å®®å´çœŒ</option>
                            <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
                            <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn btn-secondary" id="settings-reset">åˆæœŸåŒ–</button>
                <button class="btn" id="settings-save">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ====== ãƒ†ãƒ¼ãƒç®¡ç† ======
        const ThemeManager = {
            STORAGE_KEY: 'earthquake-monitor-theme',
            
            init() {
                // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’ç¢ºèªã€ãªã‘ã‚Œã°ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«å¾“ã†
                const savedTheme = localStorage.getItem(this.STORAGE_KEY);
                if (savedTheme) {
                    this.setTheme(savedTheme);
                } else {
                    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ç¢ºèª
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    this.setTheme(prefersDark ? 'dark' : 'light');
                }
                
                // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®å¤‰æ›´ã‚’ç›£è¦–
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§è¨­å®šã—ã¦ã„ãªã„å ´åˆã®ã¿è¿½å¾“
                    if (!localStorage.getItem(this.STORAGE_KEY)) {
                        this.setTheme(e.matches ? 'dark' : 'light');
                    }
                });
                
                // ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggle());
            },
            
            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                this.updateUI(theme);
                this.updateMapColors(theme);
            },
            
            toggle() {
                const current = document.documentElement.getAttribute('data-theme') || 'dark';
                const newTheme = current === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme);
                localStorage.setItem(this.STORAGE_KEY, newTheme);
            },
            
            updateUI(theme) {
                const icon = document.getElementById('theme-icon');
                const label = document.getElementById('theme-label');
                if (theme === 'dark') {
                    icon.textContent = 'ğŸŒ™';
                    label.textContent = 'ãƒ€ãƒ¼ã‚¯';
                } else {
                    icon.textContent = 'â˜€ï¸';
                    label.textContent = 'ãƒ©ã‚¤ãƒˆ';
                }
            },
            
            updateMapColors(theme) {
                // åœ°å›³ã®è‰²ã‚’ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦æ›´æ–°
                if (typeof mapSvg !== 'undefined' && mapSvg) {
                    const colors = theme === 'dark' 
                        ? { land: '#1e3a5f', border: '#3a5a8f', bgStart: '#0a1628', bgEnd: '#040810' }
                        : { land: '#a8d5ba', border: '#6db88a', bgStart: '#e8f4fc', bgEnd: '#d0e8f8' };
                    
                    // èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                    mapSvg.select('#oceanGradient stop:first-child').attr('stop-color', colors.bgStart);
                    mapSvg.select('#oceanGradient stop:last-child').attr('stop-color', colors.bgEnd);
                    
                    // éƒ½é“åºœçœŒã®è‰²æ›´æ–°ï¼ˆéœ‡åº¦ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã®ã¿ï¼‰
                    mapSvg.selectAll('.prefecture-path').each(function() {
                        const el = d3.select(this);
                        const currentScale = el.attr('data-scale');
                        if (!currentScale || currentScale === '0') {
                            el.attr('fill', colors.land)
                              .attr('data-color', colors.land);
                        }
                        el.attr('stroke', colors.border);
                    });
                }
            }
        };

        // ====== è¨­å®šç®¡ç† ======
        const SettingsManager = {
            STORAGE_KEY: 'earthquake-monitor-settings',
            
            defaults: {
                notification: false,
                notificationThreshold: 30,
                eewNotification: true,
                sound: true,
                eewSound: true,
                displayCount: 10,
                favoriteRegion: ''
            },
            
            settings: {},
            
            init() {
                // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿
                const saved = localStorage.getItem(this.STORAGE_KEY);
                this.settings = saved ? { ...this.defaults, ...JSON.parse(saved) } : { ...this.defaults };
                
                // UIã«åæ˜ 
                this.applyToUI();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                this.setupEventListeners();
                
                // é€šçŸ¥è¨±å¯çŠ¶æ…‹ã‚’æ›´æ–°
                this.updatePermissionStatus();
            },
            
            applyToUI() {
                document.getElementById('setting-notification').checked = this.settings.notification;
                document.getElementById('setting-notification-threshold').value = this.settings.notificationThreshold;
                document.getElementById('setting-eew-notification').checked = this.settings.eewNotification;
                document.getElementById('setting-sound').checked = this.settings.sound;
                document.getElementById('setting-eew-sound').checked = this.settings.eewSound;
                document.getElementById('setting-display-count').value = this.settings.displayCount;
                document.getElementById('setting-favorite-region').value = this.settings.favoriteRegion;
                
                // é€šçŸ¥ãŒã‚ªãƒ•ã®å ´åˆã€ã—ãã„å€¤ã®é¸æŠã‚’ç„¡åŠ¹åŒ–
                this.toggleThresholdVisibility();
            },
            
            setupEventListeners() {
                // è¨­å®šãƒ‘ãƒãƒ«ã®é–‹é–‰
                document.getElementById('settings-btn').addEventListener('click', () => this.openPanel());
                document.getElementById('settings-close').addEventListener('click', () => this.closePanel());
                document.getElementById('settings-overlay').addEventListener('click', (e) => {
                    if (e.target.id === 'settings-overlay') this.closePanel();
                });
                
                // ä¿å­˜ãƒ»ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('settings-save').addEventListener('click', () => this.saveAndClose());
                document.getElementById('settings-reset').addEventListener('click', () => this.reset());
                
                // é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                document.getElementById('request-permission-btn').addEventListener('click', () => this.requestNotificationPermission());
                
                // é€šçŸ¥ãƒˆã‚°ãƒ«å¤‰æ›´æ™‚
                document.getElementById('setting-notification').addEventListener('change', () => this.toggleThresholdVisibility());
            },
            
            toggleThresholdVisibility() {
                const notificationEnabled = document.getElementById('setting-notification').checked;
                const container = document.getElementById('notification-threshold-container');
                container.style.opacity = notificationEnabled ? '1' : '0.5';
                container.querySelector('select').disabled = !notificationEnabled;
            },
            
            openPanel() {
                document.getElementById('settings-overlay').classList.add('active');
                this.updatePermissionStatus();
            },
            
            closePanel() {
                document.getElementById('settings-overlay').classList.remove('active');
            },
            
            saveAndClose() {
                // UIã‹ã‚‰å€¤ã‚’å–å¾—
                this.settings.notification = document.getElementById('setting-notification').checked;
                this.settings.notificationThreshold = parseInt(document.getElementById('setting-notification-threshold').value);
                this.settings.eewNotification = document.getElementById('setting-eew-notification').checked;
                this.settings.sound = document.getElementById('setting-sound').checked;
                this.settings.eewSound = document.getElementById('setting-eew-sound').checked;
                this.settings.displayCount = parseInt(document.getElementById('setting-display-count').value);
                this.settings.favoriteRegion = document.getElementById('setting-favorite-region').value;
                
                // ä¿å­˜
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.settings));
                
                // åœ°éœ‡ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆè¡¨ç¤ºä»¶æ•°ãŒå¤‰ã‚ã£ãŸå ´åˆï¼‰
                updateQuakeList();
                
                showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                this.closePanel();
            },
            
            reset() {
                if (confirm('è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.settings = { ...this.defaults };
                    localStorage.removeItem(this.STORAGE_KEY);
                    this.applyToUI();
                    showToast('è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', 'warning');
                }
            },
            
            get(key) {
                return this.settings[key] !== undefined ? this.settings[key] : this.defaults[key];
            },
            
            // é€šçŸ¥è¨±å¯é–¢é€£
            async requestNotificationPermission() {
                if (!('Notification' in window)) {
                    showToast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }
                
                try {
                    const permission = await Notification.requestPermission();
                    this.updatePermissionStatus();
                    
                    if (permission === 'granted') {
                        showToast('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ', 'success');
                        // è‡ªå‹•çš„ã«é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã™ã‚‹
                        document.getElementById('setting-notification').checked = true;
                        this.toggleThresholdVisibility();
                    } else if (permission === 'denied') {
                        showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'error');
                    }
                } catch (e) {
                    console.error('é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', e);
                }
            },
            
            updatePermissionStatus() {
                const statusEl = document.getElementById('permission-status');
                const btnEl = document.getElementById('request-permission-btn');
                
                if (!('Notification' in window)) {
                    statusEl.textContent = 'é€šçŸ¥éå¯¾å¿œã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™';
                    statusEl.className = 'permission-status denied';
                    btnEl.style.display = 'none';
                    return;
                }
                
                const permission = Notification.permission;
                
                if (permission === 'granted') {
                    statusEl.textContent = 'âœ“ é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™';
                    statusEl.className = 'permission-status granted';
                    btnEl.style.display = 'none';
                } else if (permission === 'denied') {
                    statusEl.textContent = 'âœ• é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™';
                    statusEl.className = 'permission-status denied';
                    btnEl.textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯';
                    btnEl.disabled = true;
                } else {
                    statusEl.textContent = 'é€šçŸ¥ã®è¨±å¯ãŒå¿…è¦ã§ã™';
                    statusEl.className = 'permission-status';
                    btnEl.style.display = 'inline-block';
                    btnEl.disabled = false;
                }
            }
        };

        // ====== ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ ======
        const NotificationManager = {
            send(title, body, options = {}) {
                if (!('Notification' in window)) return;
                if (Notification.permission !== 'granted') return;
                if (!SettingsManager.get('notification')) return;
                
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš¡</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš¡</text></svg>',
                    tag: options.tag || 'earthquake',
                    requireInteraction: options.requireInteraction || false,
                    ...options
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
                // è‡ªå‹•ã§é–‰ã˜ã‚‹ï¼ˆEEWä»¥å¤–ï¼‰
                if (!options.requireInteraction) {
                    setTimeout(() => notification.close(), 10000);
                }
                
                return notification;
            },
            
            sendEarthquake(data) {
                const maxScale = data.earthquake?.maxScale;
                const threshold = SettingsManager.get('notificationThreshold');
                
                // ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯
                if (maxScale < threshold) return;
                
                // ãŠæ°—ã«å…¥ã‚Šåœ°åŸŸãƒã‚§ãƒƒã‚¯
                const favoriteRegion = SettingsManager.get('favoriteRegion');
                let isFavoriteAffected = false;
                if (favoriteRegion && data.points) {
                    isFavoriteAffected = data.points.some(p => p.pref === favoriteRegion);
                }
                
                const location = data.earthquake?.hypocenter?.name || 'ä¸æ˜';
                const scaleText = scaleToText[maxScale] || 'ä¸æ˜';
                
                let title = `åœ°éœ‡æƒ…å ± - æœ€å¤§éœ‡åº¦${scaleText}`;
                if (isFavoriteAffected) {
                    title = `âš ï¸ ${favoriteRegion}ã§æºã‚Œ - éœ‡åº¦${scaleText}`;
                }
                
                const body = `éœ‡æº: ${location}\nM${data.earthquake?.hypocenter?.magnitude || '?'}`;
                
                this.send(title, body, {
                    tag: `earthquake-${data.id}`,
                    requireInteraction: maxScale >= 50
                });
            },
            
            sendEEW(data) {
                if (!SettingsManager.get('eewNotification')) return;
                
                const eew = data.earthquake;
                const scaleText = scaleToText[eew?.maxScale] || 'ä¸æ˜';
                const location = eew?.hypocenter?.name || 'èª¿æŸ»ä¸­';
                
                this.send(
                    'âš ï¸ ç·Šæ€¥åœ°éœ‡é€Ÿå ±',
                    `äºˆæƒ³æœ€å¤§éœ‡åº¦${scaleText}\néœ‡æº: ${location}`,
                    {
                        tag: 'eew',
                        requireInteraction: true
                    }
                );
            }
        };

        // ====== è¨­å®š ======
        const WS_URL = 'wss://api.p2pquake.net/v2/ws';
        const API_URL = 'https://api.p2pquake.net/v2/history';
        const RECONNECT_INTERVAL = 5000;

        // ====== éœ‡åº¦å¤‰æ› ======
        const scaleToText = {
            10: '1', 20: '2', 30: '3', 40: '4',
            45: '5å¼±', 50: '5å¼·', 55: '6å¼±', 60: '6å¼·', 70: '7',
            '-1': 'ä¸æ˜'
        };

        const scaleToColor = {
            10: '#5b5bff', 20: '#7b7bff', 30: '#00c8ff', 40: '#00ff7f',
            45: '#ffff00', 50: '#ffc800', 55: '#ff8c00', 60: '#ff4500', 70: '#ff00ff'
        };

        // ====== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ======
        let ws = null;
        let reconnectTimer = null;
        let earthquakes = [];
        let currentEEW = null;
        let currentMapMode = 'realtime'; // 'realtime' or 'history'
        let historyData = [];

        // ====== ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ç®¡ç† ======
        const MapModeManager = {
            init() {
                document.getElementById('mode-realtime').addEventListener('click', () => this.setMode('realtime'));
                document.getElementById('mode-history').addEventListener('click', () => this.setMode('history'));
                document.getElementById('load-history').addEventListener('click', () => this.loadHistoryData());
            },
            
            setMode(mode) {
                currentMapMode = mode;
                
                // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
                document.getElementById('mode-realtime').classList.toggle('active', mode === 'realtime');
                document.getElementById('mode-history').classList.toggle('active', mode === 'history');
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
                document.getElementById('history-filter').style.display = mode === 'history' ? 'flex' : 'none';
                
                // å‡¡ä¾‹ã®åˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('legend-shindo').style.display = mode === 'realtime' ? 'grid' : 'none';
                document.getElementById('legend-magnitude').style.display = mode === 'history' ? 'grid' : 'none';
                
                // åœ°å›³ã‚’æ›´æ–°
                if (mode === 'realtime') {
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šæœ€æ–°ã®åœ°éœ‡ã‚’è¡¨ç¤º
                    this.clearHistoryMarkers();
                    if (earthquakes.length > 0) {
                        updateMap(earthquakes[0]);
                    }
                } else {
                    // ä¸€è¦§ãƒ¢ãƒ¼ãƒ‰ï¼šéå»ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                    this.loadHistoryData();
                }
            },
            
            async loadHistoryData() {
                const period = parseInt(document.getElementById('filter-period').value);
                const minScale = parseInt(document.getElementById('filter-scale').value);
                
                document.getElementById('history-count').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
                
                try {
                    // P2Påœ°éœ‡æƒ…å ±APIã‹ã‚‰éå»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæœ€å¤§100ä»¶ï¼‰
                    const response = await fetch(`${API_URL}?codes=551&limit=100`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    
                    console.log('å–å¾—ãƒ‡ãƒ¼ã‚¿:', data.length, 'ä»¶');
                    
                    // æœŸé–“ã¨éœ‡åº¦ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    const now = new Date();
                    const cutoffTime = new Date(now.getTime() - period * 60 * 60 * 1000);
                    
                    historyData = data.filter(eq => {
                        const timeStr = eq.earthquake?.time;
                        const eqTime = parseJapanTime(timeStr);
                        const scale = eq.earthquake?.maxScale || 0;
                        
                        // ãƒ‡ãƒãƒƒã‚°ç”¨
                        // console.log('åœ°éœ‡:', timeStr, 'â†’', eqTime, 'scale:', scale, 'minScale:', minScale);
                        
                        if (!eqTime) return false;
                        return eqTime >= cutoffTime && scale >= minScale;
                    });
                    
                    console.log('ãƒ•ã‚£ãƒ«ã‚¿å¾Œ:', historyData.length, 'ä»¶');
                    document.getElementById('history-count').textContent = `${historyData.length}ä»¶ã®åœ°éœ‡`;
                    
                    // åœ°å›³ã«è¡¨ç¤º
                    this.displayHistoryOnMap();
                    
                } catch (e) {
                    console.error('éå»ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                    document.getElementById('history-count').textContent = 'å–å¾—å¤±æ•—';
                    showToast('éå»ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            },
            
            clearHistoryMarkers() {
                if (mapSvg) {
                    mapSvg.select('#history-markers').remove();
                    mapSvg.select('#map-popup-layer').remove();
                }
            },
            
            displayHistoryOnMap() {
                if (!mapSvg || !projection) return;
                
                // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                this.clearHistoryMarkers();
                
                // éƒ½é“åºœçœŒã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
                const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
                const defaultColor = isDark ? '#1e3a5f' : '#a8d5ba';
                mapSvg.selectAll('.prefecture-path')
                    .attr('fill', defaultColor)
                    .attr('data-color', defaultColor)
                    .attr('data-scale', '0');
                
                // éœ‡æºãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
                const markersLayer = mapSvg.append('g').attr('id', 'history-markers');
                const popupLayer = mapSvg.append('g').attr('id', 'map-popup-layer');
                
                // éœ‡æºã‚’ãƒ—ãƒ­ãƒƒãƒˆï¼ˆå¤ã„é †ã«æç”»ã—ã¦æ–°ã—ã„ã‚‚ã®ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰
                const sortedData = [...historyData].reverse();
                
                sortedData.forEach((eq, index) => {
                    const hypo = eq.earthquake?.hypocenter;
                    if (!hypo?.latitude || !hypo?.longitude) return;
                    
                    const coords = projection([hypo.longitude, hypo.latitude]);
                    // æŠ•å½±çµæœãŒNaNã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (!coords || isNaN(coords[0]) || isNaN(coords[1])) return;
                    
                    const [x, y] = coords;
                    const scale = eq.earthquake?.maxScale || 10;
                    const mag = hypo.magnitude || 1;
                    
                    // ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚µã‚¤ã‚ºï¼ˆæœ€å°5ã€æœ€å¤§25ï¼‰
                    const radius = Math.max(5, Math.min(25, mag * 4));
                    
                    // éœ‡åº¦ã«å¿œã˜ãŸè‰²
                    const color = scaleToColor[scale] || '#5b5bff';
                    
                    // å¤ã„ã‚‚ã®ã¯é€æ˜åº¦ã‚’ä¸‹ã’ã‚‹
                    const opacity = 0.4 + (index / sortedData.length) * 0.6;
                    
                    // å††ã‚’æç”»
                    const circle = markersLayer.append('circle')
                        .attr('cx', x)
                        .attr('cy', y)
                        .attr('r', radius)
                        .attr('fill', color)
                        .attr('fill-opacity', opacity)
                        .attr('stroke', '#fff')
                        .attr('stroke-width', 1)
                        .attr('stroke-opacity', opacity * 0.8)
                        .attr('cursor', 'pointer')
                        .attr('data-eq-id', eq.id);
                    
                    // ãƒ›ãƒãƒ¼åŠ¹æœã¨ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    circle
                        .on('mouseover', function() {
                            d3.select(this)
                                .attr('stroke-width', 2)
                                .attr('fill-opacity', 1);
                        })
                        .on('mouseout', function() {
                            d3.select(this)
                                .attr('stroke-width', 1)
                                .attr('fill-opacity', opacity);
                        })
                        .on('click', () => this.showPopup(eq, x, y));
                });
                
                // éœ‡æºãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆä¸€è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯å€‹åˆ¥éœ‡æºÃ—ã‚’è¡¨ç¤ºã—ãªã„ï¼‰
                mapSvg.select('#epicenter-layer').selectAll('*').remove();
            },
            
            showPopup(eq, x, y) {
                const popupLayer = mapSvg.select('#map-popup-layer');
                popupLayer.selectAll('*').remove();
                
                const hypo = eq.earthquake?.hypocenter;
                const scale = eq.earthquake?.maxScale || 0;
                const scaleText = scaleToText[scale] || 'ä¸æ˜';
                const color = scaleToColor[scale] || '#666';
                const location = hypo?.name || 'ä¸æ˜';
                const time = formatTime(eq.earthquake?.time);
                const mag = hypo?.magnitude || '?';
                const depth = hypo?.depth > 0 ? `${hypo.depth}km` : 'ä¸æ˜';
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®ã®èª¿æ•´ï¼ˆç”»é¢ç«¯ã§ã®èª¿æ•´ï¼‰
                const mapWidth = mapSvg.node().getBoundingClientRect().width;
                let popupX = x;
                let popupY = y - 100;
                
                // HTMLã‚’foreignObjectã§æç”»
                const fo = popupLayer.append('foreignObject')
                    .attr('x', popupX - 110)
                    .attr('y', popupY)
                    .attr('width', 220)
                    .attr('height', 120);
                
                const popup = fo.append('xhtml:div')
                    .attr('class', 'map-popup')
                    .style('position', 'relative')
                    .style('background', 'var(--bg-secondary)')
                    .style('border', '1px solid var(--border-color)')
                    .style('border-radius', '8px')
                    .style('padding', '12px')
                    .style('box-shadow', '0 4px 20px rgba(0,0,0,0.3)');
                
                popup.html(`
                    <button class="map-popup-close" onclick="MapModeManager.closePopup()">âœ•</button>
                    <div class="map-popup-title">
                        <span class="map-popup-shindo" style="background:${color}">éœ‡åº¦${scaleText}</span>
                        ${location}
                    </div>
                    <div class="map-popup-info">
                        ${time}<br>
                        M${mag} / æ·±ã•${depth}
                    </div>
                `);
            },
            
            closePopup() {
                if (mapSvg) {
                    mapSvg.select('#map-popup-layer').selectAll('*').remove();
                }
            }
        };

        // ====== WebSocketæ¥ç¶š ======
        let pollingTimer = null;
        const POLLING_INTERVAL = 60000; // 1åˆ†ã”ã¨ã«APIã‹ã‚‰å–å¾—

        function connect() {
            updateStatus('connecting', 'æ¥ç¶šä¸­...');
            
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                updateStatus('connected', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å—ä¿¡ä¸­');
                showToast('P2Påœ°éœ‡æƒ…å ±ã«æ¥ç¶šã—ã¾ã—ãŸ', 'success');
                clearTimeout(reconnectTimer);
                
                // æ¥ç¶šæ™‚ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                fetchInitialData();
                
                // å®šæœŸãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
                startPolling();
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };
            
            ws.onclose = () => {
                updateStatus('disconnected', 'åˆ‡æ–­');
                stopPolling();
                scheduleReconnect();
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('disconnected', 'ã‚¨ãƒ©ãƒ¼');
            };
        }

        function startPolling() {
            stopPolling(); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            pollingTimer = setInterval(() => {
                console.log('å®šæœŸãƒ‡ãƒ¼ã‚¿åŒæœŸ...');
                fetchLatestData();
            }, POLLING_INTERVAL);
        }

        function stopPolling() {
            if (pollingTimer) {
                clearInterval(pollingTimer);
                pollingTimer = null;
            }
        }

        function scheduleReconnect() {
            reconnectTimer = setTimeout(() => {
                showToast('å†æ¥ç¶šä¸­...', 'warning');
                connect();
            }, RECONNECT_INTERVAL);
        }

        function reconnect() {
            document.getElementById('reconnect-modal').classList.remove('active');
            connect();
        }

        // ====== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† ======
        function handleMessage(data) {
            console.log('Received:', data.code, data);
            
            switch (data.code) {
                case 551: // åœ°éœ‡æƒ…å ±
                    handleEarthquakeInfo(data);
                    break;
                case 552: // æ´¥æ³¢äºˆå ±
                    handleTsunamiInfo(data);
                    break;
                case 556: // ç·Šæ€¥åœ°éœ‡é€Ÿå ±ï¼ˆè­¦å ±ï¼‰
                    handleEEW(data);
                    break;
                case 561: // åœ°éœ‡æ„ŸçŸ¥æƒ…å ±
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ„ŸçŸ¥æƒ…å ±ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰
                    break;
            }
        }

        function handleEarthquakeInfo(data) {
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (earthquakes.some(eq => eq.id === data.id)) return;
            
            earthquakes.unshift(data);
            if (earthquakes.length > 20) earthquakes.pop();
            
            updateQuakeList();
            updateMap(data);
            updateLastUpdateTime();
            
            const maxScale = data.earthquake?.maxScale;
            
            // è­¦å‘ŠéŸ³ï¼ˆè¨­å®šã«å¾“ã†ï¼‰
            if (maxScale >= 40 && SettingsManager.get('sound')) {
                playAlert();
            }
            
            // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥
            NotificationManager.sendEarthquake(data);
            
            // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆéœ‡åº¦4ä»¥ä¸Šï¼‰
            if (maxScale >= 40) {
                showToast(`éœ‡åº¦${scaleToText[maxScale]}ã®åœ°éœ‡ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, 'warning');
            }
        }

        function handleEEW(data) {
            currentEEW = data;
            const panel = document.getElementById('eew-panel');
            const info = document.getElementById('eew-info');
            
            panel.classList.add('active');
            
            // è­¦å‘ŠéŸ³ï¼ˆè¨­å®šã«å¾“ã†ï¼‰
            if (SettingsManager.get('eewSound')) {
                playEEWAlert();
            }
            
            // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥
            NotificationManager.sendEEW(data);
            
            const eew = data.earthquake;
            info.innerHTML = `
                <div class="eew-active">
                    <div class="eew-title">âš ï¸ ç·Šæ€¥åœ°éœ‡é€Ÿå ±ï¼ˆè­¦å ±ï¼‰</div>
                    <div class="eew-shindo" style="color: ${scaleToColor[eew.maxScale] || '#fff'}">
                        éœ‡åº¦ ${scaleToText[eew.maxScale] || 'ä¸æ˜'}
                    </div>
                    <div class="eew-details">
                        <div>éœ‡æº: ${eew.hypocenter?.name || 'èª¿æŸ»ä¸­'}</div>
                        <div>æ·±ã•: ${eew.hypocenter?.depth > 0 ? eew.hypocenter.depth + 'km' : 'ä¸æ˜'}</div>
                        <div>M${eew.hypocenter?.magnitude || 'èª¿æŸ»ä¸­'}</div>
                        <div style="margin-top:10px; font-size:0.9rem; color:#888;">
                            ${formatTime(data.time)}
                        </div>
                    </div>
                </div>
            `;
            
            // 30ç§’å¾Œã«è§£é™¤
            setTimeout(() => {
                panel.classList.remove('active');
                info.innerHTML = `
                    <div class="eew-waiting">
                        ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã‚’ç›£è¦–ä¸­...<br>
                        <small style="color:#666;">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å—ä¿¡ã—ã¾ã™</small>
                    </div>
                `;
            }, 30000);
        }

        function handleTsunamiInfo(data) {
            if (data.cancelled) return;
            showToast('ğŸŒŠ æ´¥æ³¢äºˆå ±ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸ', 'error');
        }

        // ====== UIæ›´æ–° ======
        function updateStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            dot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        function updateQuakeList() {
            const list = document.getElementById('quake-list');
            const displayCount = SettingsManager.get('displayCount') || 10;
            const favoriteRegion = SettingsManager.get('favoriteRegion');
            
            if (earthquakes.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">åœ°éœ‡æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            list.innerHTML = earthquakes.slice(0, displayCount).map(eq => {
                const info = eq.earthquake || {};
                const scale = info.maxScale || -1;
                const color = scaleToColor[scale] || '#666';
                const location = info.hypocenter?.name || 'éœ‡æºä¸æ˜';
                const time = formatTime(eq.earthquake?.time);
                const mag = info.hypocenter?.magnitude > 0 ? `M${info.hypocenter.magnitude}` : '';
                const depth = info.hypocenter?.depth > 0 ? `æ·±ã•${info.hypocenter.depth}km` : '';
                
                // ãŠæ°—ã«å…¥ã‚Šåœ°åŸŸãŒã“ã®åœ°éœ‡ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                let isFavoriteAffected = false;
                if (favoriteRegion && eq.points) {
                    isFavoriteAffected = eq.points.some(p => p.pref === favoriteRegion);
                }
                
                return `
                    <div class="quake-item ${isFavoriteAffected ? 'favorite-affected' : ''}" onclick="showQuakeDetail('${eq.id}')">
                        <div class="quake-shindo" style="background: ${color}">
                            ${scaleToText[scale] || '?'}
                        </div>
                        <div class="quake-info">
                            <div class="quake-location">${isFavoriteAffected ? 'â­ ' : ''}${location}</div>
                            <div class="quake-meta">${time} ${mag} ${depth}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showQuakeDetail(id) {
            const eq = earthquakes.find(e => e.id === id);
            if (eq) updateMap(eq);
        }

        // ====== åœ°å›³è¡¨ç¤º ======
        // dataofjapan ã® GeoJSON ã‚’ä½¿ç”¨
        const GEOJSON_URL = 'https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson';
        let geoData = null;
        let mapSvg = null;
        let projection = null;
        let pathGenerator = null;

        async function initMap() {
            const mapContainer = document.getElementById('japan-map');
            const loadingEl = document.getElementById('map-loading');
            
            // SVGã‚’ä½œæˆ
            const width = mapContainer.clientWidth || 700;
            const height = 550;
            
            mapSvg = d3.select('#japan-map')
                .append('svg')
                .attr('width', '100%')
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .style('background', 'linear-gradient(180deg, #0a1628 0%, #061018 100%)');
            
            // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©ï¼ˆå…ˆã«å®šç¾©ã—ã¦ã‹ã‚‰ä½¿ç”¨ï¼‰
            const defs = mapSvg.append('defs');
            const gradient = defs.append('radialGradient')
                .attr('id', 'oceanGradient')
                .attr('cx', '50%')
                .attr('cy', '50%')
                .attr('r', '70%');
            gradient.append('stop').attr('offset', '0%').attr('stop-color', '#0a1628');
            gradient.append('stop').attr('offset', '100%').attr('stop-color', '#040810');
            
            // èƒŒæ™¯
            mapSvg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .attr('fill', 'url(#oceanGradient)');
            
            try {
                console.log('åœ°å›³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­:', GEOJSON_URL);
                // GeoJSONã‚’èª­ã¿è¾¼ã¿
                const response = await fetch(GEOJSON_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                geoData = await response.json();
                
                console.log('GeoJSONèª­ã¿è¾¼ã¿æˆåŠŸ:', geoData.features?.length, 'éƒ½é“åºœçœŒ');
                
                // æŠ•å½±æ³•ã®è¨­å®šï¼ˆæ—¥æœ¬å‘ã‘ï¼‰
                projection = d3.geoMercator()
                    .center([137, 38])
                    .scale(1400)
                    .translate([width / 2, height / 2]);
                
                pathGenerator = d3.geoPath().projection(projection);
                
                // éƒ½é“åºœçœŒã‚’æç”»
                const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
                const landColor = isDark ? '#1e3a5f' : '#a8d5ba';
                const borderColor = isDark ? '#3a5a8f' : '#6db88a';
                
                mapSvg.append('g')
                    .attr('id', 'prefectures-layer')
                    .selectAll('path')
                    .data(geoData.features)
                    .enter()
                    .append('path')
                    .attr('d', pathGenerator)
                    .attr('class', 'prefecture-path')
                    .attr('data-pref', d => d.properties.nam_ja || d.properties.name || '')
                    .attr('fill', landColor)
                    .attr('stroke', borderColor)
                    .attr('stroke-width', 0.5)
                    .on('mouseover', function() {
                        const hoverColor = document.documentElement.getAttribute('data-theme') !== 'light' ? '#2a4a7f' : '#8fc9a3';
                        d3.select(this).attr('fill', hoverColor);
                    })
                    .on('mouseout', function() {
                        const currentColor = d3.select(this).attr('data-color') || landColor;
                        d3.select(this).attr('fill', currentColor);
                    });
                
                // éœ‡æºè¡¨ç¤ºç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼
                mapSvg.append('g').attr('id', 'epicenter-layer');
                
                console.log('åœ°å›³æç”»å®Œäº†');
                
            } catch (e) {
                console.error('GeoJSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                showToast('åœ°å›³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç°¡æ˜“ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
                mapSvg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#666')
                    .text('åœ°å›³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ');
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        }

        function updateMap(earthquake) {
            // ä¸€è¦§ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å€‹åˆ¥ã®åœ°éœ‡æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (currentMapMode === 'history') return;
            
            if (!earthquake || !mapSvg) return;
            
            const points = earthquake.points || [];
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const defaultColor = isDark ? '#1e3a5f' : '#a8d5ba';
            
            // éƒ½é“åºœçœŒã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
            mapSvg.selectAll('.prefecture-path')
                .attr('fill', defaultColor)
                .attr('data-color', defaultColor)
                .attr('data-scale', '0');
            
            // éƒ½é“åºœçœŒã”ã¨ã®æœ€å¤§éœ‡åº¦ã‚’é›†è¨ˆ
            const prefMaxScale = {};
            points.forEach(point => {
                const pref = point.pref;
                const scale = point.scale;
                if (!prefMaxScale[pref] || scale > prefMaxScale[pref]) {
                    prefMaxScale[pref] = scale;
                }
            });
            
            // éœ‡åº¦ã‚’åæ˜ ï¼ˆéƒ½é“åºœçœŒåã®è¡¨è¨˜ã‚†ã‚Œã«å¯¾å¿œï¼‰
            Object.entries(prefMaxScale).forEach(([pref, scale]) => {
                const color = scaleToColor[scale] || '#1e3a5f';
                mapSvg.selectAll('.prefecture-path')
                    .filter(function() {
                        const dataPref = d3.select(this).attr('data-pref') || '';
                        // ã€ŒçœŒã€ã€Œåºœã€ã€Œéƒ½ã€ã€Œé“ã€ã®æœ‰ç„¡ã«å¯¾å¿œ
                        return dataPref === pref || 
                               dataPref === pref.replace(/[éƒ½é“åºœçœŒ]$/, '') ||
                               pref === dataPref.replace(/[éƒ½é“åºœçœŒ]$/, '');
                    })
                    .attr('fill', color)
                    .attr('data-color', color)
                    .attr('data-scale', scale);
            });
            
            // éœ‡æºè¡¨ç¤º
            const hypo = earthquake.earthquake?.hypocenter;
            if (hypo?.latitude && hypo?.longitude && projection) {
                showEpicenter(hypo.latitude, hypo.longitude);
            }
        }

        function showEpicenter(lat, lon) {
            if (!projection || !mapSvg) return;
            
            const coords = projection([lon, lat]);
            // æŠ•å½±çµæœãŒNaNã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (!coords || isNaN(coords[0]) || isNaN(coords[1])) return;
            
            const [x, y] = coords;
            const layer = mapSvg.select('#epicenter-layer');
            
            // æ—¢å­˜ã®éœ‡æºãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            layer.selectAll('*').remove();
            
            // ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®å††
            for (let i = 0; i < 3; i++) {
                layer.append('circle')
                    .attr('cx', x)
                    .attr('cy', y)
                    .attr('r', 5)
                    .attr('fill', 'none')
                    .attr('stroke', '#ff0000')
                    .attr('stroke-width', 2)
                    .attr('opacity', 1)
                    .transition()
                    .delay(i * 500)
                    .duration(1500)
                    .ease(d3.easeLinear)
                    .attr('r', 50)
                    .attr('opacity', 0)
                    .on('end', function repeat() {
                        d3.select(this)
                            .attr('r', 5)
                            .attr('opacity', 1)
                            .transition()
                            .duration(1500)
                            .ease(d3.easeLinear)
                            .attr('r', 50)
                            .attr('opacity', 0)
                            .on('end', repeat);
                    });
            }
            
            // éœ‡æºãƒãƒ¼ã‚¯ï¼ˆÃ—ï¼‰
            layer.append('text')
                .attr('x', x)
                .attr('y', y + 5)
                .attr('text-anchor', 'middle')
                .attr('font-size', '20px')
                .attr('font-weight', 'bold')
                .attr('fill', '#ff0000')
                .text('Ã—');
        }

        // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
        function formatTime(timeStr) {
            if (!timeStr) return '';
            try {
                // P2Påœ°éœ‡æƒ…å ±ã®å½¢å¼: "2025/12/28 19:30:00" ãªã©
                // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥å½¢å¼ã‚’ãã®ã¾ã¾å‡¦ç†
                const match = timeStr.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})\s+(\d{1,2}):(\d{2})/);
                if (match) {
                    const [, year, month, day, hour, minute] = match;
                    return `${parseInt(month)}/${parseInt(day)} ${hour}:${minute}`;
                }
                // ISOå½¢å¼ã®å ´åˆ
                const date = new Date(timeStr);
                if (!isNaN(date.getTime())) {
                    return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                }
                return timeStr;
            } catch {
                return timeStr;
            }
        }

        // æ—¥æœ¬æ™‚é–“å½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ï¼ˆSafariå¯¾å¿œï¼‰
        function parseJapanTime(timeStr) {
            if (!timeStr) return null;
            try {
                // P2Påœ°éœ‡æƒ…å ±ã®å½¢å¼: "2025/12/28 19:30:00"
                const match = timeStr.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})\s+(\d{1,2}):(\d{2}):(\d{2})/);
                if (match) {
                    const [, year, month, day, hour, minute, second] = match;
                    return new Date(
                        parseInt(year),
                        parseInt(month) - 1, // æœˆã¯0å§‹ã¾ã‚Š
                        parseInt(day),
                        parseInt(hour),
                        parseInt(minute),
                        parseInt(second)
                    );
                }
                // ç§’ãŒãªã„å ´åˆ
                const match2 = timeStr.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})\s+(\d{1,2}):(\d{2})/);
                if (match2) {
                    const [, year, month, day, hour, minute] = match2;
                    return new Date(
                        parseInt(year),
                        parseInt(month) - 1,
                        parseInt(day),
                        parseInt(hour),
                        parseInt(minute),
                        0
                    );
                }
                // ISOå½¢å¼ãªã©ã®å ´åˆ
                const date = new Date(timeStr);
                return isNaN(date.getTime()) ? null : date;
            } catch {
                return null;
            }
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleString('ja-JP', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            document.getElementById('current-time').textContent = timeStr;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
        }

        function playAlert() {
            // ç°¡æ˜“ãƒ“ãƒ¼ãƒ—éŸ³
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 880;
                gain.gain.value = 0.3;
                osc.start();
                setTimeout(() => osc.stop(), 200);
            } catch (e) {}
        }

        function playEEWAlert() {
            // ç·Šæ€¥åœ°éœ‡é€Ÿå ±è­¦å‘ŠéŸ³ï¼ˆé€£ç¶šãƒ“ãƒ¼ãƒ—ï¼‰
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = 1000;
                        gain.gain.value = 0.5;
                        osc.start();
                        setTimeout(() => osc.stop(), 150);
                    }, i * 250);
                }
            } catch (e) {}
        }

        // ====== åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾— ======
        async function fetchInitialData() {
            try {
                const response = await fetch(`${API_URL}?codes=551&limit=20`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                
                // åˆå›ã¯å…¨ç½®æ›
                earthquakes = data;
                updateQuakeList();
                updateLastUpdateTime();
                
                if (data.length > 0) {
                    updateMap(data[0]);
                }
                console.log('åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data.length, 'ä»¶');
            } catch (e) {
                console.error('Failed to fetch initial data:', e);
                showToast('åˆæœŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                // ãƒªã‚¹ãƒˆã‚’ç©ºçŠ¶æ…‹ã«æ›´æ–°
                document.getElementById('quake-list').innerHTML = 
                    '<div style="text-align: center; color: var(--text-muted); padding: 20px;">ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ã€‚WebSocketã§å—ä¿¡ã—ã¾ã™ã€‚</div>';
            }
        }

        // å®šæœŸçš„ã«APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå·®åˆ†ãƒãƒ¼ã‚¸ï¼‰
        async function fetchLatestData() {
            try {
                const response = await fetch(`${API_URL}?codes=551&limit=10`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                
                let newCount = 0;
                
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ãªã„æ–°ã—ã„åœ°éœ‡ã‚’å…ˆé ­ã«è¿½åŠ 
                data.reverse().forEach(newEq => {
                    if (!earthquakes.some(eq => eq.id === newEq.id)) {
                        earthquakes.unshift(newEq);
                        newCount++;
                        
                        // é€šçŸ¥å‡¦ç†
                        const maxScale = newEq.earthquake?.maxScale;
                        if (maxScale >= 40 && SettingsManager.get('sound')) {
                            playAlert();
                        }
                        NotificationManager.sendEarthquake(newEq);
                        if (maxScale >= 40) {
                            showToast(`éœ‡åº¦${scaleToText[maxScale]}ã®åœ°éœ‡ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, 'warning');
                        }
                    }
                });
                
                // æœ€å¤§ä¿æŒä»¶æ•°ã‚’åˆ¶é™
                if (earthquakes.length > 30) {
                    earthquakes = earthquakes.slice(0, 30);
                }
                
                // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’æ›´æ–°
                updateLastUpdateTime();
                
                if (newCount > 0) {
                    console.log(`æ–°ã—ã„åœ°éœ‡æƒ…å ±: ${newCount}ä»¶`);
                    updateQuakeList();
                    updateMap(earthquakes[0]);
                }
                
            } catch (e) {
                console.error('Failed to fetch latest data:', e);
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}æ›´æ–°`;
            const el = document.getElementById('last-update');
            if (el) el.textContent = timeStr;
        }

        // ====== åˆæœŸåŒ– ======
        async function init() {
            // ãƒ†ãƒ¼ãƒã®åˆæœŸåŒ–
            ThemeManager.init();
            
            // è¨­å®šã®åˆæœŸåŒ–
            SettingsManager.init();
            
            // ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
            MapModeManager.init();
            
            updateClock();
            setInterval(updateClock, 1000);
            
            await initMap();
            
            // åœ°å›³èª­ã¿è¾¼ã¿å¾Œã«ãƒ†ãƒ¼ãƒã®è‰²ã‚’é©ç”¨
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            ThemeManager.updateMapColors(currentTheme);
            
            // WebSocketæ¥ç¶šé–‹å§‹ï¼ˆæ¥ç¶šæ™‚ã«ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚‚è¡Œã†ï¼‰
            connect();
        }

        init();
    </script>
</body>
</html>
