<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="iPhoneのバッテリー残量を簡単に確認できるWebアプリ。端末名、充電回数、実測残量などの詳細情報を提供します。">
    <meta name="keywords" content="iPhone, バッテリー残量, バッテリー健康度, 充電回数, Webアプリ">
    <title>iPhoneバッテリー残量確認アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        .error-message {
            background-color: #FEE2E2;
            border: 1px solid #EF4444;
            color: #991B1B;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        .success-message {
            background-color: #D1FAE5;
            border: 1px solid #059669;
            color: #065F46;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        .drag-over {
            border-color: #3B82F6 !important;
            background-color: #EFF6FF !important;
        }
        [aria-invalid="true"] {
            border-color: #EF4444 !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">
    <div role="main" class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white shadow-2xl rounded-lg overflow-hidden">
            <header class="bg-gradient-to-r from-blue-500 to-purple-600 p-6">
                <h1 class="text-3xl font-bold text-white">iPhoneバッテリー残量確認アプリ</h1>
            </header>

            <div class="p-6 space-y-6">
                <form id="batteryCheckForm" class="space-y-6" novalidate>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="deviceModel" class="block text-sm font-medium text-gray-700 mb-2">
                                端末名 (必須)
                            </label>
                            <select 
                                id="deviceModel" 
                                name="deviceModel"
                                class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                required
                                aria-required="true"
                                aria-label="iPhoneの機種を選択してください"
                                aria-describedby="deviceModelError">
                            </select>
                            <div id="deviceModelError" class="error-message hidden"></div>
                        </div>
                        <div>
                            <label for="initialCapacity" class="block text-sm font-medium text-gray-700 mb-2">
                                初期搭載容量 (mAh)
                            </label>
                            <input 
                                id="initialCapacity" 
                                type="number" 
                                class="w-full p-3 border border-gray-300 rounded-md shadow-sm bg-gray-50"
                                readonly
                                aria-label="選択された機種の初期バッテリー容量">
                        </div>
                    </div>

                    <div>
                        <label for="logInput" class="block text-sm font-medium text-gray-700 mb-2">
                            ログデータ (必須)
                        </label>
                        <textarea 
                            id="logInput" 
                            name="logInput"
                            class="w-full h-40 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            required
                            aria-required="true"
                            aria-label="バッテリーログデータを入力"
                            aria-describedby="logInputError"
                            placeholder="ここにログを貼り付けてください。「Analytics-YYYY-MM-DD.synced」ファイルの中身を貼り付けてください。"></textarea>
                        <div id="logInputError" class="error-message hidden"></div>
                    </div>

                    <div>
                        <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2">
                            または、ログファイルをアップロード
                        </label>
                        <input 
                            type="file" 
                            id="fileInput" 
                            accept=".synced,text/plain"
                            class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            aria-label="ログファイルをアップロード">
                        <div id="fileInputError" class="error-message hidden"></div>
                    </div>

                    <div class="flex justify-center">
                        <button 
                            type="submit"
                            id="extractButton" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-md shadow-lg hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300"
                            aria-label="バッテリー情報を解析">
                            解析開始
                        </button>
                    </div>
                </form>

                <div 
                    id="result" 
                    class="bg-gray-50 p-6 rounded-lg shadow-inner" 
                    role="region" 
                    aria-live="polite"
                    aria-atomic="true">
                </div>

                <div class="mt-8 p-6 bg-blue-50 rounded-lg shadow-md">
                    <p class="text-gray-700 mb-4">iPhone14以前のモデルでは、フル充電サイクルを500回繰り返した後も本来の蓄電容量の80%を維持するよう設計されています。</p>
                    <a href="https://support.apple.com/ja-jp/106348" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       class="text-blue-600 hover:text-blue-800 transition duration-300"
                       aria-label="Apple公式サポートサイトで詳細を確認">
                        詳細情報 ※Apple公式サポートサイトへリンクします。
                    </a>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 iPhoneバッテリー残量確認アプリ All Rights Reserved.</p>
            <p class="mt-2">制作: たぬ | 開発支援: Claude 3.5 (Anthropic AI)</p>
            <p class="mt-2">Version 1.2.0 "Battery Health Checker" (2024-10-29 20:00)</p>
            <p class="mt-4 text-sm">
                This application uses:
                <a href="https://tailwindcss.com/" 
                   target="_blank" 
                   rel="noopener noreferrer" 
                   class="text-blue-300 hover:text-blue-100">
                    Tailwind CSS
                </a> (MIT License)
            </p>
        </div>
    </footer>

    <script>
        const deviceCapacities = {
            "iPhone": 1400,
            "iPhone 3G": 1150,
            "iPhone 3GS": 1219,
            "iPhone 4": 1432,
            "iPhone 4s": 1419,
            "iPhone 5": 1434,
            "iPhone 5c": 1508,
            "iPhone 5s": 1558,
            "iPhone 6": 1810,
            "iPhone 6 Plus": 2906,
            "iPhone 6s": 1715,
            "iPhone 6s Plus": 2705,
            "iPhone SE": 1624,
            "iPhone 7": 1961,
            "iPhone 7 Plus": 2906,
            "iPhone 8": 1821,
            "iPhone 8 Plus": 2675,
            "iPhone X": 2700,
            "iPhone XS": 2658,
            "iPhone XS Max": 3174,
            "iPhone XR": 2942,
            "iPhone 11": 3110,
            "iPhone 11 Pro": 3046,
            "iPhone 11 Pro Max": 3969,
            "iPhone SE (2nd generation)": 1821,
            "iPhone 12": 2815,
            "iPhone 12 mini": 2227,
            "iPhone 12 Pro": 2815,
            "iPhone 12 Pro Max": 3687,
            "iPhone 13": 3095,
            "iPhone 13 mini": 2406,
            "iPhone 13 Pro": 3095,
            "iPhone 13 Pro Max": 4352,
            "iPhone 14": 3279,
            "iPhone 14 Plus": 4325,
            "iPhone 14 Pro": 3200,
            "iPhone 14 Pro Max": 4323,
            "iPhone 15": 3349,
            "iPhone 15 Plus": 4383,
            "iPhone 15 Pro": 3274,
            "iPhone 15 Pro Max": 4422,
            "iPhone 16": 3561,
            "iPhone 16 Plus": 4674,
            "iPhone 16 Pro": 3582,
            "iPhone 16 Pro Max": 4685
        };

        // エラーメッセージの定義
        const ERROR_MESSAGES = {
            INVALID_LOG_FORMAT: 'ログファイルの形式が正しくありません。正しいログファイルを使用してください。',
            EMPTY_LOG: 'ログデータが入力されていません。',
            FILE_READ_ERROR: 'ファイルの読み込み中にエラーが発生しました。',
            DEVICE_NOT_SELECTED: '端末を選択してください。',
            PARSING_ERROR: 'ログの解析中にエラーが発生しました。',
            INVALID_FILE_TYPE: '未対応のファイル形式です。.syncedファイルを使用してください。'
        };

        // 入力値のバリデーション
        function validateInput(logText, deviceModel) {
            const errors = [];

            if (!deviceModel) {
                errors.push({
                    field: 'deviceModel',
                    message: ERROR_MESSAGES.DEVICE_NOT_SELECTED
                });
            }

            if (!logText || logText.trim().length === 0) {
                errors.push({
                    field: 'logInput',
                    message: ERROR_MESSAGES.EMPTY_LOG
                });
            } else if (!isValidLogFormat(logText)) {
                errors.push({
                    field: 'logInput',
                    message: ERROR_MESSAGES.INVALID_LOG_FORMAT
                });
            }

            return errors;
        }

        // ログフォーマットの検証
        function isValidLogFormat(logText) {
            const requiredPatterns = [
                /"timestamp"/,
                /"last_value_CycleCount"/,
                /"last_value_NominalChargeCapacity"/,
                /"last_value_AppleRawMaxCapacity"/
            ];

            return requiredPatterns.every(pattern => pattern.test(logText));
        }

        // エラー表示の管理
        function displayError(fieldId, message) {
            const errorElement = document.getElementById(`${fieldId}Error`);
            const inputElement = document.getElementById(fieldId);

            if (errorElement && inputElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
                inputElement.setAttribute('aria-invalid', 'true');
                inputElement.setAttribute('aria-errormessage', `${fieldId}Error`);
            }
        }

        // エラー表示のクリア
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            const inputElements = document.querySelectorAll('[aria-invalid]');

            errorElements.forEach(element => {
                element.classList.add('hidden');
                element.textContent = '';
            });

            inputElements.forEach(element => {
                element.removeAttribute('aria-invalid');
                element.removeAttribute('aria-errormessage');
            });
        }

        // ログ情報の抽出
        function extractInfo(logText) {
            try {
                const patterns = {
                    timestamp: /"timestamp":"([^"]+)"/,
                    cycleCount: /"last_value_CycleCount":(\d+)/,
                    nominalCapacity: /"last_value_NominalChargeCapacity":(\d+)/,
                    actualCapacity: /"last_value_AppleRawMaxCapacity":(\d+)/
                };

                const extracted = {};
                let isValid = true;

                for (const [key, pattern] of Object.entries(patterns)) {
                    const match = logText.match(pattern);
                    if (match) {
                        extracted[key] = match[1];
                    } else {
                        isValid = false;
                        break;
                    }
                }

                return isValid ? extracted : null;
            } catch (error) {
                console.error('ログ解析エラー:', error);
                return null;
            }
        }

        // デバイスオプションの生成
        function populateDeviceOptions() {
            const deviceModel = document.getElementById('deviceModel');
            const fragment = document.createDocumentFragment();
            
            // デフォルトオプション
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '端末を選択してください';
            fragment.appendChild(defaultOption);
            
            // デバイスリストの追加
            Object.keys(deviceCapacities).forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                fragment.appendChild(option);
            });
            
            deviceModel.appendChild(fragment);
        }

        // 容量の更新
        function updateCapacity() {
            const deviceModel = document.getElementById('deviceModel');
            const initialCapacity = document.getElementById('initialCapacity');
            initialCapacity.value = deviceModel.value ? deviceCapacities[deviceModel.value] : '';
        }

        // パーセンテージの計算
        function calculatePercentage(value, total) {
            return ((value / total) * 100).toFixed(2);
        }

        // バッテリー状態コメントの取得
        function getBatteryHealthComment(degradation) {
            if (degradation < 5) return "新品同様でしょう！";
            if (degradation < 10) return "ほぼ新品同様！";
            if (degradation < 15) return "少し心配だけどまだ大丈夫！";
            if (degradation < 20) return "そろそろ交換かも";
            return "交換した方が良いかも";
        }

        // 結果の表示
        function displayResult(result) {
            const resultDiv = document.getElementById('result');
            if (!result) {
                resultDiv.innerHTML = `
                    <div class="error-message" role="alert">
                        ${ERROR_MESSAGES.PARSING_ERROR}
                    </div>
                `;
                return;
            }

            const deviceModel = document.getElementById('deviceModel');
            const initialCapacity = document.getElementById('initialCapacity');

            const modelName = deviceModel.value;
            const capacity = initialCapacity.value;

            const nominalPercentage = calculatePercentage(result.nominalCapacity, capacity);
            const actualPercentage = calculatePercentage(result.actualCapacity, capacity);
            const degradation = (100 - actualPercentage).toFixed(2);
            const healthComment = getBatteryHealthComment(parseFloat(degradation));

            resultDiv.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">解析結果</h2>
                <div class="space-y-3">
                    <p><span class="font-medium text-gray-700">端末名:</span> <span class="text-blue-600">${modelName}</span></p>
                    <p><span class="font-medium text-gray-700">初期搭載容量:</span> <span class="text-blue-600">${capacity} mAh</span></p>
                    <p><span class="font-medium text-gray-700">確認日:</span> <span class="text-blue-600">${result.timestamp}</span></p>
                    <p><span class="font-medium text-gray-700">充電回数:</span> <span class="text-blue-600">${result.cycleCount}</span></p>
                    <p><span class="font-medium text-gray-700">公称残量:</span> <span class="text-blue-600">${result.nominalCapacity} mAh (${nominalPercentage}%)</span></p>
                    <p><span class="font-medium text-gray-700">実測残量:</span> <span class="text-blue-600">${result.actualCapacity} mAh (${actualPercentage}%)</span></p>
                    <p><span class="font-medium text-gray-700">バッテリー消耗率:</span> <span class="text-blue-600">${degradation}%</span></p>
                    <p><span class="font-medium text-gray-700">バッテリー状態:</span> <span class="text-green-600 font-bold">${healthComment}</span></p>
                </div>
            `;
        }

        // ファイルの処理
        function handleFile(file) {
            if (!file.name.endsWith('.synced') && file.type !== 'text/plain') {
                displayError('fileInput', ERROR_MESSAGES.INVALID_FILE_TYPE);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    document.getElementById('logInput').value = e.target.result;
                    clearErrors();
                } catch (error) {
                    displayError('fileInput', ERROR_MESSAGES.FILE_READ_ERROR);
                    console.error('ファイル読み込みエラー:', error);
                }
            };

            reader.onerror = function() {
                displayError('fileInput', ERROR_MESSAGES.FILE_READ_ERROR);
                console.error('ファイル読み込みエラー:', reader.error);
            };

            reader.readAsText(file);
        }

        // ドラッグ&ドロップの設定
        function setupDragAndDrop() {
            const dropZone = document.getElementById('logInput');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            dropZone.addEventListener('dragenter', () => {
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                dropZone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFile(file);
                }
            });
        }

        // フォームの送信処理
        function handleFormSubmit(e) {
            e.preventDefault();
            clearErrors();

            const deviceModel = document.getElementById('deviceModel').value;
            const logText = document.getElementById('logInput').value;

            const validationErrors = validateInput(logText, deviceModel);
            if (validationErrors.length > 0) {
                validationErrors.forEach(error => {
                    displayError(error.field, error.message);
                });
                return;
            }

            const result = extractInfo(logText);
            displayResult(result);
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            const form = document.getElementById('batteryCheckForm');
            const deviceModel = document.getElementById('deviceModel');
            const fileInput = document.getElementById('fileInput');

            form.addEventListener('submit', handleFormSubmit);
            deviceModel.addEventListener('change', updateCapacity);
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // 入力フィールドの変更時にエラーをクリア
            ['deviceModel', 'logInput'].forEach(fieldId => {
                document.getElementById(fieldId).addEventListener('input', () => {
                    clearErrors();
                });
            });
        }

        // アプリケーションの初期化
        function initializeApp() {
            populateDeviceOptions();
            updateCapacity();
            setupDragAndDrop();
            setupEventListeners();
        }

        // アプリケーションの起動
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>