<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マンガページレイアウトデザイナー</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fd79a8;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #00b894;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background-color: #f5f5f7;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }
        
        .col {
            flex: 1;
            min-width: 300px;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-title svg {
            width: 20px;
            height: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2);
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #5549d6;
        }
        
        button.secondary {
            background-color: var(--secondary);
        }
        
        button.secondary:hover {
            background-color: #8b7ffd;
        }
        
        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .grid-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .grid-layout {
            display: grid;
            gap: 0;
            background-color: #ddd;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 1rem;
            aspect-ratio: 1/1.4;
            /* A4用紙の比率に近い */
            position: relative;
        }
        
        .grid-cell {
            background-color: white;
            position: relative;
            transition: background-color 0.2s;
            min-height: 30px;
            border: 1px solid #ddd;
        }
        
        .grid-cell:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
        
        .grid-cell.selected {
            background-color: rgba(108, 92, 231, 0.2);
        }
        
        .grid-cell.panel {
            background-color: rgba(108, 92, 231, 0.2);
            position: relative;
            border: none;
            z-index: 1;
        }
        
        .grid-cell.panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(108, 92, 231, 0.2);
            z-index: -1;
        }
        
        .grid-cell.panel-top {
            border-top: 2px solid var(--primary);
        }
        
        .grid-cell.panel-right {
            border-right: 2px solid var(--primary);
        }
        
        .grid-cell.panel-bottom {
            border-bottom: 2px solid var(--primary);
        }
        
        .grid-cell.panel-left {
            border-left: 2px solid var(--primary);
        }
        
        .panel-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            z-index: 2;
        }
        
        .panel-form {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .panel-form:last-child {
            border-bottom: none;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .panel-title {
            font-weight: bold;
            color: var(--primary);
        }
        
        .prompt-preview {
            white-space: pre-wrap;
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .output-section {
            margin-top: 2rem;
        }
        
        .preview-image {
            width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }
        
        .copy-button {
            background-color: var(--success);
            margin-top: 0.5rem;
        }
        
        .copy-button:hover {
            background-color: #00a383;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .panel-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        /* モバイル対応 */
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .col {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>マンガページレイアウトデザイナー</h1>
        <p>コマ割りを自由にデザインし、各コマの詳細を設定できます</p>
    </header>
    
    <div class="container">
        <div class="card">
            <div class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                作品情報
            </div>
            <div>
                <label for="manga-title">タイトル</label>
                <input type="text" id="manga-title" placeholder="例: 耳の奥の囁き" value="耳の奥の囁き" oninput="generatePrompt()">
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                            <line x1="15" y1="3" x2="15" y2="21"></line>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="3" y1="15" x2="21" y2="15"></line>
                        </svg>
                        コマ割りデザイン
                    </div>
                    <div class="grid-controls">
                        <div>
                            <label for="grid-orientation">方向：</label>
                            <select id="grid-orientation" onchange="updateGrid()">
                                <option value="vertical">縦型（一般的な漫画）</option>
                                <option value="horizontal">横型（四コマ漫画など）</option>
                            </select>
                        </div>
                        <div>
                            <label for="grid-size">グリッドサイズ：</label>
                            <select id="grid-size" onchange="updateGrid()">
                                <option value="4">4x4</option>
                                <option value="6" selected>6x6</option>
                                <option value="8">8x8</option>
                                <option value="10">10x10</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="grid-layout" class="grid-layout"></div>
                    
                    <div class="button-group">
                        <button id="add-panel-btn" onclick="startNewPanel()">新しいコマを追加</button>
                        <button id="clear-selection-btn" onclick="clearSelection()" class="secondary">選択をクリア</button>
                        <button id="reset-grid-btn" onclick="resetGrid()" class="secondary">すべてリセット</button>
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="card">
                    <div class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                        コマの詳細設定
                    </div>
                    <div id="panel-list" class="panel-list"></div>
                </div>
            </div>
        </div>
        
        <div class="card output-section">
            <div class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                出力結果
            </div>
            <div>
                <label>生成されたプロンプト：</label>
                <pre id="prompt-preview" class="prompt-preview"></pre>
                <button id="copy-prompt-btn" onclick="copyPrompt()" class="copy-button">プロンプトをコピー</button>
            </div>
            <div class="action-buttons">
                <button id="export-image-btn" onclick="exportImage()">レイアウト画像を保存</button>
                <button id="generate-prompt-btn" onclick="generatePrompt()">プロンプトを生成</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentPanelNumber = 0;
        let selectedCells = [];
        let panels = [];
        
        // 初期化時にグリッドを生成
        document.addEventListener('DOMContentLoaded', function() {
            updateGrid();
        });
        
        // グリッドの更新
        function updateGrid() {
            const gridLayout = document.getElementById('grid-layout');
            const gridSize = parseInt(document.getElementById('grid-size').value);
            const orientation = document.getElementById('grid-orientation').value;
            
            // グリッドをクリア
            gridLayout.innerHTML = '';
            
            // 新しいグリッドのスタイルを設定
            if (orientation === 'vertical') {
                gridLayout.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
                gridLayout.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;
            } else {
                gridLayout.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
                gridLayout.style.gridTemplateRows = `repeat(${gridSize}, 1fr)`;
                gridLayout.style.aspectRatio = '1.4/1'; // 横型の場合は比率を逆にする
            }
            
            // セルを生成
            for (let i = 0; i < gridSize * gridSize; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.index = i;
                cell.addEventListener('click', toggleCellSelection);
                gridLayout.appendChild(cell);
            }
            
            // パネルを再描画
            redrawPanels();
        }
        
        // セルの選択/選択解除
        function toggleCellSelection(event) {
            const cell = event.target;
            const index = parseInt(cell.dataset.index);
            
            // 既にパネルに割り当てられているセルは選択できない
            if (cell.classList.contains('panel')) {
                return;
            }
            
            if (cell.classList.contains('selected')) {
                cell.classList.remove('selected');
                selectedCells = selectedCells.filter(cellIndex => cellIndex !== index);
            } else {
                cell.classList.add('selected');
                selectedCells.push(index);
            }
        }
        
        // 新しいパネルの追加を開始
        function startNewPanel() {
            if (selectedCells.length === 0) {
                alert('コマにするセルを選択してください');
                return;
            }
            
            // 次のパネル番号を決定
            currentPanelNumber++;
            
            // パネルを作成
            const newPanel = {
                id: currentPanelNumber,
                cells: [...selectedCells],
                shotType: '',
                description: '',
                dialogue: '',
                position: ''
            };
            
            panels.push(newPanel);
            
            // 選択されたセルをパネルとしてマーク
            markPanelBorders(selectedCells, currentPanelNumber);
            
            // パネル設定フォームを追加
            addPanelForm(newPanel);
            
            // 選択をクリア
            selectedCells = [];
            
            // プロンプトを更新
            generatePrompt();
        }
        
        // パネル設定フォームを追加
        function addPanelForm(panel) {
            const panelList = document.getElementById('panel-list');
            const panelForm = document.createElement('div');
            panelForm.className = 'panel-form';
            panelForm.id = `panel-form-${panel.id}`;
            panelForm.innerHTML = `
                <div class="panel-header">
                    <div class="panel-title">コマ ${panel.id}</div>
                    <button onclick="removePanel(${panel.id})" class="secondary">削除</button>
                </div>
                <div>
                    <label for="panel-${panel.id}-position">コマの位置</label>
                    <input type="text" id="panel-${panel.id}-position" placeholder="おまかせ（例: 上部横長、右下小、中央大など）" 
                           value="${panel.position}" onchange="updatePanelData(${panel.id}, 'position', this.value)">
                </div>
                <div>
                    <label for="panel-${panel.id}-shot">ショットタイプ</label>
                    <input type="text" id="panel-${panel.id}-shot" placeholder="おまかせ（全景、中景、アップなど）" 
                           value="${panel.shotType}" onchange="updatePanelData(${panel.id}, 'shotType', this.value)">
                </div>
                <div>
                    <label for="panel-${panel.id}-desc">描写/トーン</label>
                    <textarea id="panel-${panel.id}-desc" rows="3" placeholder="おまかせ（例: 廃墟と化した神殿のような建物。床の半分が透き通った水に沈んでいる。）"
                              onchange="updatePanelData(${panel.id}, 'description', this.value)">${panel.description}</textarea>
                </div>
                <div>
                    <label for="panel-${panel.id}-dialogue">セリフ/ナレーション (任意)</label>
                    <textarea id="panel-${panel.id}-dialogue" rows="2" placeholder="例: 「ここは一体...」"
                              onchange="updatePanelData(${panel.id}, 'dialogue', this.value)">${panel.dialogue}</textarea>
                </div>
            `;
            panelList.appendChild(panelForm);
        }
        
        // パネルデータの更新
        function updatePanelData(panelId, field, value) {
            const panel = panels.find(p => p.id === panelId);
            if (panel) {
                panel[field] = value;
                generatePrompt();
            }
        }
        
        // パネルの削除
        function removePanel(panelId) {
            // パネルに割り当てられたセルを解放
            const panelToRemove = panels.find(p => p.id === panelId);
            if (panelToRemove) {
                panelToRemove.cells.forEach(cellIndex => {
                    const cell = document.querySelector(`.grid-cell[data-index="${cellIndex}"]`);
                    cell.classList.remove('panel', 'panel-top', 'panel-right', 'panel-bottom', 'panel-left');
                    cell.removeAttribute('data-panel-id');
                    // パネル番号表示を削除
                    const panelNumber = cell.querySelector('.panel-number');
                    if (panelNumber) {
                        cell.removeChild(panelNumber);
                    }
                });
                
                // パネルをリストから削除
                panels = panels.filter(p => p.id !== panelId);
                
                // フォームを削除
                const panelForm = document.getElementById(`panel-form-${panelId}`);
                if (panelForm) {
                    panelForm.remove();
                }
                
                // パネル番号を振り直す
                renumberPanels();
                
                // プロンプトを更新
                generatePrompt();
            }
        }
        
        // パネル番号を振り直す
        function renumberPanels() {
            // パネルを並べ替え
            panels.sort((a, b) => a.id - b.id);
            
            // 番号を振り直し
            panels.forEach((panel, index) => {
                const newPanelNumber = index + 1;
                
                // パネルIDを更新
                const oldId = panel.id;
                panel.id = newPanelNumber;
                
                // フォームのIDと表示を更新
                const panelForm = document.getElementById(`panel-form-${oldId}`);
                if (panelForm) {
                    panelForm.id = `panel-form-${newPanelNumber}`;
                    const panelTitle = panelForm.querySelector('.panel-title');
                    if (panelTitle) {
                        panelTitle.textContent = `コマ ${newPanelNumber}`;
                    }
                    
                    // 入力フィールドのIDと関連付けを更新
                    const shotInput = panelForm.querySelector(`#panel-${oldId}-shot`);
                    const descInput = panelForm.querySelector(`#panel-${oldId}-desc`);
                    const dialogueInput = panelForm.querySelector(`#panel-${oldId}-dialogue`);
                    
                    if (shotInput) {
                        shotInput.id = `panel-${newPanelNumber}-shot`;
                        shotInput.setAttribute('onchange', `updatePanelData(${newPanelNumber}, 'shotType', this.value)`);
                    }
                    
                    if (descInput) {
                        descInput.id = `panel-${newPanelNumber}-desc`;
                        descInput.setAttribute('onchange', `updatePanelData(${newPanelNumber}, 'description', this.value)`);
                    }
                    
                    if (dialogueInput) {
                        dialogueInput.id = `panel-${newPanelNumber}-dialogue`;
                        dialogueInput.setAttribute('onchange', `updatePanelData(${newPanelNumber}, 'dialogue', this.value)`);
                    }
                    
                    // 削除ボタンの関連付けを更新
                    const removeButton = panelForm.querySelector('button');
                    if (removeButton) {
                        removeButton.setAttribute('onclick', `removePanel(${newPanelNumber})`);
                    }
                }
                
                // グリッド上のパネル番号表示を更新
                panel.cells.forEach(cellIndex => {
                    const cell = document.querySelector(`.grid-cell[data-index="${cellIndex}"]`);
                    if (cell) {
                        cell.dataset.panelId = newPanelNumber;
                        const panelNumber = cell.querySelector('.panel-number');
                        if (panelNumber) {
                            panelNumber.textContent = newPanelNumber;
                        }
                    }
                });
            });
            
            // 現在のパネル番号を更新
            currentPanelNumber = panels.length;
        }
        
        // 選択中のセルをクリア
        function clearSelection() {
            selectedCells.forEach(cellIndex => {
                const cell = document.querySelector(`.grid-cell[data-index="${cellIndex}"]`);
                if (cell) {
                    cell.classList.remove('selected');
                }
            });
            selectedCells = [];
        }
        
        // グリッドとパネルをリセット
        function resetGrid() {
            if (confirm('すべてのコマ割りとデータをリセットしますか？')) {
                // グリッドのセルをクリア
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('selected', 'panel');
                    cell.removeAttribute('data-panel-id');
                    
                    // パネル番号表示を削除
                    const panelNumber = cell.querySelector('.panel-number');
                    if (panelNumber) {
                        cell.removeChild(panelNumber);
                    }
                });
                
                // パネルデータとフォームをクリア
                panels = [];
                currentPanelNumber = 0;
                selectedCells = [];
                document.getElementById('panel-list').innerHTML = '';
                
                // プロンプトをクリア
                generatePrompt();
            }
        }
        
        // パネルを再描画
        function redrawPanels() {
            // まずセルのクラスをリセット
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('panel', 'panel-top', 'panel-right', 'panel-bottom', 'panel-left');
                cell.removeAttribute('data-panel-id');
                
                // パネル番号表示を削除
                const panelNumber = cell.querySelector('.panel-number');
                if (panelNumber) {
                    cell.removeChild(panelNumber);
                }
            });
            
            // パネルを再描画
            panels.forEach(panel => {
                markPanelBorders(panel.cells, panel.id);
            });
        }
        
        // パネルの境界線を特定し、適切なクラスを設定する
        function markPanelBorders(cellIndices, panelId) {
            const gridSize = parseInt(document.getElementById('grid-size').value);
            
            // すべてのセルをパネルとしてマーク
            cellIndices.forEach(cellIndex => {
                const cell = document.querySelector(`.grid-cell[data-index="${cellIndex}"]`);
                if (cell) {
                    cell.classList.remove('selected');
                    cell.classList.add('panel');
                    cell.dataset.panelId = panelId;
                }
            });
            
            // 境界線を特定するためにグリッド上での位置を計算
            const cellPositions = cellIndices.map(index => {
                return {
                    index: index,
                    row: Math.floor(index / gridSize),
                    col: index % gridSize
                };
            });
            
            // 上下左右の境界を特定
            cellPositions.forEach(pos => {
                const cell = document.querySelector(`.grid-cell[data-index="${pos.index}"]`);
                
                // 上の境界
                if (!cellPositions.some(p => p.row === pos.row - 1 && p.col === pos.col)) {
                    cell.classList.add('panel-top');
                }
                
                // 右の境界
                if (!cellPositions.some(p => p.row === pos.row && p.col === pos.col + 1)) {
                    cell.classList.add('panel-right');
                }
                
                // 下の境界
                if (!cellPositions.some(p => p.row === pos.row + 1 && p.col === pos.col)) {
                    cell.classList.add('panel-bottom');
                }
                
                // 左の境界
                if (!cellPositions.some(p => p.row === pos.row && p.col === pos.col - 1)) {
                    cell.classList.add('panel-left');
                }
            });
            
            // パネルの中心を見つける
            const centerRow = Math.floor(cellPositions.reduce((sum, pos) => sum + pos.row, 0) / cellPositions.length);
            const centerCol = Math.floor(cellPositions.reduce((sum, pos) => sum + pos.col, 0) / cellPositions.length);
            
            // 中心に最も近いセルを見つける
            let minDistance = Infinity;
            let centerCellIndex = cellIndices[0];
            
            cellPositions.forEach(pos => {
                const distance = Math.pow(pos.row - centerRow, 2) + Math.pow(pos.col - centerCol, 2);
                if (distance < minDistance) {
                    minDistance = distance;
                    centerCellIndex = pos.index;
                }
            });
            
            // 中心のセルにパネル番号を表示
            const centerCell = document.querySelector(`.grid-cell[data-index="${centerCellIndex}"]`);
            if (centerCell) {
                const panelNumberEl = document.createElement('span');
                panelNumberEl.className = 'panel-number';
                panelNumberEl.textContent = panelId;
                centerCell.appendChild(panelNumberEl);
            }
        }
        
        // プロンプトを生成
        function generatePrompt() {
            const mangaTitle = document.getElementById('manga-title').value || 'タイトル未設定';
            let promptText = `タイトル：「${mangaTitle}」\n\n`;
            
            panels.sort((a, b) => a.id - b.id).forEach(panel => {
                const positionText = panel.position ? `（${panel.position}）` : '';
                promptText += `コマ${panel.id}${positionText}： [${panel.shotType || 'おまかせ'}]\n`;
                promptText += `${panel.description || 'おまかせ'}\n`;
                
                if (panel.dialogue && panel.dialogue.trim()) {
                    promptText += `セリフ: ${panel.dialogue}\n`;
                }
                
                promptText += '\n';
            });
            
            document.getElementById('prompt-preview').textContent = promptText;
        }
        
        // プロンプトをクリップボードにコピー
        function copyPrompt() {
            const promptText = document.getElementById('prompt-preview').textContent;
            navigator.clipboard.writeText(promptText).then(() => {
                alert('プロンプトをクリップボードにコピーしました');
            }).catch(err => {
                console.error('クリップボードへのコピーに失敗しました:', err);
                alert('クリップボードへのコピーに失敗しました');
            });
        }
        
        // レイアウト画像をエクスポート
        function exportImage() {
            const gridLayout = document.getElementById('grid-layout');
            const mangaTitle = document.getElementById('manga-title').value || 'マンガレイアウト';
            
            // Canvas要素を作成
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // グリッドのサイズを取得
            const gridRect = gridLayout.getBoundingClientRect();
            canvas.width = gridRect.width;
            canvas.height = gridRect.height;
            
            // 背景を白で塗りつぶす
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const gridSize = parseInt(document.getElementById('grid-size').value);
            const cellWidth = canvas.width / gridSize;
            const cellHeight = canvas.height / gridSize;
            
            // 各パネルを描画
            panels.forEach(panel => {
                const cellPositions = panel.cells.map(index => {
                    return {
                        index,
                        row: Math.floor(index / gridSize),
                        col: index % gridSize
                    };
                });
                
                // パネルの範囲を見つける
                const minRow = Math.min(...cellPositions.map(pos => pos.row));
                const maxRow = Math.max(...cellPositions.map(pos => pos.row));
                const minCol = Math.min(...cellPositions.map(pos => pos.col));
                const maxCol = Math.max(...cellPositions.map(pos => pos.col));
                
                // セルをすべて埋める
                ctx.fillStyle = 'rgba(108, 92, 231, 0.2)';
                cellPositions.forEach(pos => {
                    const x = pos.col * cellWidth;
                    const y = pos.row * cellHeight;
                    ctx.fillRect(x, y, cellWidth, cellHeight);
                });
                
                // パネルの境界線を描画
                ctx.strokeStyle = '#6c5ce7';
                ctx.lineWidth = 3;
                
                // 上下左右の境界を特定して線を引く
                cellPositions.forEach(pos => {
                    const x = pos.col * cellWidth;
                    const y = pos.row * cellHeight;
                    
                    // 上の境界
                    if (!cellPositions.some(p => p.row === pos.row - 1 && p.col === pos.col)) {
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x + cellWidth, y);
                        ctx.stroke();
                    }
                    
                    // 右の境界
                    if (!cellPositions.some(p => p.row === pos.row && p.col === pos.col + 1)) {
                        ctx.beginPath();
                        ctx.moveTo(x + cellWidth, y);
                        ctx.lineTo(x + cellWidth, y + cellHeight);
                        ctx.stroke();
                    }
                    
                    // 下の境界
                    if (!cellPositions.some(p => p.row === pos.row + 1 && p.col === pos.col)) {
                        ctx.beginPath();
                        ctx.moveTo(x, y + cellHeight);
                        ctx.lineTo(x + cellWidth, y + cellHeight);
                        ctx.stroke();
                    }
                    
                    // 左の境界
                    if (!cellPositions.some(p => p.row === pos.row && p.col === pos.col - 1)) {
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x, y + cellHeight);
                        ctx.stroke();
                    }
                });
                
                // パネルの中心位置を計算
                const centerX = (minCol + (maxCol - minCol) / 2) * cellWidth + cellWidth / 2;
                const centerY = (minRow + (maxRow - minRow) / 2) * cellHeight + cellHeight / 2;
                
                // パネル番号を描画
                ctx.fillStyle = '#6c5ce7';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(panel.id.toString(), centerX, centerY);
            });
            
            // タイトルを描画
            ctx.fillStyle = '#343a40';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(mangaTitle + ' - コマ割りレイアウト', canvas.width / 2, 10);
            
            // 画像をダウンロード
            try {
                // データURLに変換
                const dataURL = canvas.toDataURL('image/png');
                
                // ダウンロードリンクを作成
                const downloadLink = document.createElement('a');
                downloadLink.href = dataURL;
                downloadLink.download = mangaTitle + '_layout.png';
                
                // リンクをクリック（ダウンロード開始）
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            } catch (e) {
                console.error('画像の生成に失敗しました:', e);
                // Safariユーザー向けのフォールバックメッセージ
                alert('Macでのスクリーンショット方法:\n' +
                      '1. Command (⌘) + Shift + 4 を押します\n' +
                      '2. スペースキーを押すとカメラアイコンに変わります\n' +
                      '3. ブラウザのウィンドウをクリックすると、そのウィンドウ全体のスクリーンショットが取得できます\n\n' +
                      'または、Command (⌘) + Shift + 5 でスクリーンショットツールを開き、領域を選択することもできます。');
            }
        }
    </script>
</body>
</html>