<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>炎を灯そう - 完全版</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #1a1a1a;
            font-family: sans-serif;
        }
        .game-container {
            text-align: center;
            color: #fff;
        }
        .scene {
            width: 600px;
            height: 400px;
            background: #2a2a2a;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px;
            transition: background-color 0.5s;
        }
        .candle {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 100px;
            background: #f0f0f0;
            border-radius: 10px;
        }
        .wick {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 10px;
            background: #333;
        }
        .wind-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .wind-particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
        }
        .wind-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: windMove 1s linear infinite;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .wind-direction-indicator {
            position: absolute;
            top: 20px;
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        .wind-arrow {
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 20px solid rgba(255, 255, 255, 0.2);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .wind-strength {
            position: absolute;
            top: 70px;
            width: 100%;
            text-align: center;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .flame {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ff6b00, #ff0000);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            opacity: 0;
            transition: transform 0.3s;
        }
        .flame.windy {
            animation: flameWind 0.5s infinite alternate;
        }
        .shield {
            position: absolute;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
            border: 2px solid rgba(0, 255, 255, 0.2);
            border-radius: 50%;
            display: none;
            animation: shieldPulse 2s infinite;
        }
        .matches-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .matches {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .match {
            width: 100px;
            height: 20px;
            cursor: pointer;
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .match:hover {
            transform: scale(1.1);
        }
        .match-stick {
            width: 100px;
            height: 20px;
            background: #8b4513;
        }
        .match-tip {
            width: 20px;
            height: 20px;
            border-radius: 5px;
        }
        .match-normal .match-tip { background: #ff0000; }
        .match-strong .match-tip { background: #ff00ff; }
        .match-shield .match-tip { background: #00ffff; }
        .match-label {
            font-size: 0.8em;
            margin-top: 5px;
            color: #fff;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .progress {
            width: 80%;
            height: 20px;
            background: #333;
            margin: 20px auto;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #ff6b00, #ff0000);
            transition: width 0.5s;
        }
        .message {
            margin: 20px;
            font-size: 1.2em;
            min-height: 1.5em;
        }
        .light-radius {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 107, 0, 0.2), transparent);
            border-radius: 50%;
            transition: all 0.5s;
        }

        @keyframes windMove {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes flameWind {
            0% {
                transform: translateX(-50%) skewX(0deg);
            }
            100% {
                transform: translateX(-50%) skewX(-20deg);
            }
        }

        @keyframes shieldPulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 0.6; }
            100% { transform: scale(1); opacity: 0.8; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>炎を灯そう</h1>
        <div class="scene">
            <div class="wind-effect"></div>
            <div class="wind-direction-indicator">
                <div class="wind-arrow"></div>
                <div class="wind-arrow"></div>
                <div class="wind-arrow"></div>
            </div>
            <div class="wind-strength">弱い風</div>
            <div class="light-radius"></div>
            <div class="candle">
                <div class="wick"></div>
                <div class="flame"></div>
            </div>
            <div class="shield"></div>
        </div>
        <div class="stats">
            <div>スコア: <span id="score">0</span></div>
            <div>残り時間: <span id="timer">60</span>秒</div>
            <div>最高記録: <span id="highscore">0</span></div>
        </div>
        <div class="progress">
            <div class="progress-bar"></div>
        </div>
        <div class="message">マッチを使って、ろうそくに火を灯してください</div>
        <div class="matches-container">
            <div class="matches">
                <div class="match match-normal" onclick="useMatch('normal', 0)">
                    <div class="match-stick">
                        <div class="match-tip"></div>
                    </div>
                    <div class="match-label">通常のマッチ</div>
                </div>
                <div class="match match-strong" onclick="useMatch('strong', 1)">
                    <div class="match-stick">
                        <div class="match-tip"></div>
                    </div>
                    <div class="match-label">強力なマッチ</div>
                </div>
                <div class="match match-shield" onclick="useMatch('shield', 2)">
                    <div class="match-stick">
                        <div class="match-tip"></div>
                    </div>
                    <div class="match-label">防風マッチ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let progress = 0;
        let score = 0;
        let highscore = localStorage.getItem('highscore') || 0;
        let timeLeft = 60;
        let gameTimer;
        let windInterval;
        let isShieldActive = false;
        
        document.getElementById('highscore').textContent = highscore;

        const matches = {
            normal: { count: 3, power: 20 },
            strong: { count: 2, power: 35 },
            shield: { count: 1, power: 15 }
        };

        function startGame() {
            resetGame();
            startTimer();
            startWind();
        }

        function createWindParticles() {
            const windEffect = document.querySelector('.wind-effect');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'wind-line';
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.width = `${50 + Math.random() * 100}px`;
                windEffect.appendChild(particle);
            }
        }

        function updateWindVisuals(strength) {
            const flame = document.querySelector('.flame');
            const arrows = document.querySelectorAll('.wind-arrow');
            const strengthIndicator = document.querySelector('.wind-strength');
            const windLines = document.querySelectorAll('.wind-line');

            let strengthText = '弱い風';
            let arrowCount = 1;
            let lineOpacity = 0.3;

            if (strength > 0.7) {
                strengthText = '強い風';
                arrowCount = 3;
                lineOpacity = 1;
            } else if (strength > 0.4) {
                strengthText = '中程度の風';
                arrowCount = 2;
                lineOpacity = 0.6;
            }

            strengthIndicator.textContent = strengthText;
            strengthIndicator.style.opacity = '1';

            arrows.forEach((arrow, index) => {
                arrow.style.opacity = index < arrowCount ? '1' : '0';
            });

            windLines.forEach(line => {
                line.style.opacity = lineOpacity;
            });

            if (flame.style.opacity === '1') {
                flame.classList.add('windy');
            }

            setTimeout(() => {
                strengthIndicator.style.opacity = '0';
                arrows.forEach(arrow => arrow.style.opacity = '0');
                windLines.forEach(line => line.style.opacity = '0');
                flame.classList.remove('windy');
            }, 2000);
        }

        function startTimer() {
            gameTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function startWind() {
            createWindParticles();
            windInterval = setInterval(() => {
                if (!isShieldActive && document.querySelector('.flame').style.opacity === '1') {
                    const windStrength = Math.random();
                    updateWindVisuals(windStrength);
                    
                    if (windStrength > 0.7) {
                        reduceFlame();
                    }
                }
            }, 3000);
        }

        function useMatch(type, index) {
            if (matches[type].count <= 0) return;
            
            matches[type].count--;
            document.querySelectorAll('.match')[index].style.opacity = '0.5';
            
            const flame = document.querySelector('.flame');
            flame.style.opacity = '1';
            
            if (type === 'shield') {
                activateShield();
            }
            
            progress += matches[type].power;
            if (progress > 100) progress = 100;
            
            updateProgress();
            updateScore();
            updateLightRadius();
        }

        function activateShield() {
            isShieldActive = true;
            const shield = document.querySelector('.shield');
            shield.style.display = 'block';
            shield.style.left = '225px';
            shield.style.top = '125px';
            
            setTimeout(() => {
                shield.style.display = 'none';
                isShieldActive = false;
            }, 5000);
        }

        function reduceFlame() {
            progress -= 15;
            if (progress < 0) progress = 0;
            updateProgress();
            updateLightRadius();
            
            if (progress === 0) {
                document.querySelector('.flame').style.opacity = '0';
            }
        }

        function updateProgress() {
            document.querySelector('.progress-bar').style.width = progress + '%';
        }

        function updateScore() {
            score += Math.floor(progress / 10);
            document.getElementById('score').textContent = score;
        }

        function updateLightRadius() {
            const radius = progress * 2;
            const lightRadius = document.querySelector('.light-radius');
            lightRadius.style.width = radius + 'px';
            lightRadius.style.height = radius + 'px';
            
            const scene = document.querySelector('.scene');
            const brightness = Math.floor(progress / 2);
            scene.style.backgroundColor = `rgb(${42 + brightness}, ${42 + brightness}, ${42 + brightness})`;
        }

        function endGame() {
            clearInterval(gameTimer);
            clearInterval(windInterval);
            
            if (score > highscore) {
                highscore = score;
                localStorage.setItem('highscore', highscore);
                document.getElementById('highscore').textContent = highscore;
                document.querySelector('.message').textContent = `新記録達成！ スコア: ${score}`;
            } else {
                document.querySelector('.message').textContent = `ゲーム終了！ スコア: ${score}`;
            }

            // 全ての風の効果をクリア
            const windLines = document.querySelectorAll('.wind-line');
            windLines.forEach(line => line.style.opacity = '0');
            
            const arrows = document.querySelectorAll('.wind-arrow');
            arrows.forEach(arrow => arrow.style.opacity = '0');
            
            document.querySelector('.wind-strength').style.opacity = '0';
        }

        function resetGame() {
            // 基本的なゲーム状態のリセット
            progress = 0;
            score = 0;
            timeLeft = 60;
            document.getElementById('score').textContent = '0';
            document.getElementById('timer').textContent = '60';
            document.querySelector('.progress-bar').style.width = '0%';
            document.querySelector('.flame').style.opacity = '0';
            document.querySelector('.message').textContent = "マッチを使って、ろうそくに火を灯してください";
            
            // マッチの数をリセット
            matches.normal.count = 3;
            matches.strong.count = 2;
            matches.shield.count = 1;
            
            // マッチの表示をリセット
            document.querySelectorAll('.match').forEach(match => match.style.opacity = '1');
            
            // 風の効果をリセット
            const windLines = document.querySelectorAll('.wind-line');
            windLines.forEach(line => line.remove());
            
            // シールドの状態をリセット
            isShieldActive = false;
            document.querySelector('.shield').style.display = 'none';
            
            // 光の効果をリセット
            updateLightRadius();
            
            // 背景の明るさをリセット
            document.querySelector('.scene').style.backgroundColor = '#2a2a2a';
            
            // 風の方向インディケーターをリセット
            document.querySelectorAll('.wind-arrow').forEach(arrow => arrow.style.opacity = '0');
            document.querySelector('.wind-strength').style.opacity = '0';
        }

        // ゲーム開始時の初期化
        function initializeGame() {
            // ハイスコアの初期化
            if (!localStorage.getItem('highscore')) {
                localStorage.setItem('highscore', '0');
            }
            document.getElementById('highscore').textContent = localStorage.getItem('highscore');

            // 風のパーティクル要素の初期生成
            createWindParticles();

            // ゲームの開始
            startGame();
        }

        // キーボードイベントの追加
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case '1':
                    useMatch('normal', 0);
                    break;
                case '2':
                    useMatch('strong', 1);
                    break;
                case '3':
                    useMatch('shield', 2);
                    break;
                case 'r':
                case 'R':
                    if (timeLeft <= 0) {
                        startGame();
                    }
                    break;
            }
        });

        // タッチデバイスのサポート
        let touchStartX = 0;
        document.querySelector('.scene').addEventListener('touchstart', (event) => {
            touchStartX = event.touches[0].clientX;
        });

        document.querySelector('.scene').addEventListener('touchmove', (event) => {
            if (isShieldActive) {
                const shield = document.querySelector('.shield');
                const touch = event.touches[0];
                const rect = document.querySelector('.scene').getBoundingClientRect();
                const x = touch.clientX - rect.left - 75; // シールドの半分の幅を引く
                const y = touch.clientY - rect.top - 75; // シールドの半分の高さを引く
                
                shield.style.left = `${Math.max(0, Math.min(x, rect.width - 150))}px`;
                shield.style.top = `${Math.max(0, Math.min(y, rect.height - 150))}px`;
            }
        });

        // 画面サイズ変更対応
        window.addEventListener('resize', () => {
            const scene = document.querySelector('.scene');
            const shield = document.querySelector('.shield');
            if (shield.style.display === 'block') {
                const rect = scene.getBoundingClientRect();
                shield.style.left = '225px';
                shield.style.top = '125px';
            }
        });

        // ゲーム初期化と開始
        initializeGame();
    </script>
</body>
</html>